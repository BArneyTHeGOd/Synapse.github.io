<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Synapse</title>
    <link rel="icon" href="https://fonts.gstatic.com/s/i/productlogos/drive_2020q4/v8/drive_2020q4_48dp.png" type="image/png">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f6f7f8; /* Light gray background for the entire page */
        }
        .sidebar {
            width: 280px; /* Fixed width for the sidebar */
            flex-shrink: 0;
            background-color: white;
            border-right: 1px solid #e0e0e0;
        }
        .header {
            background-color: white;
            border-bottom: 1px solid #e0e0e0;
        }
        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); /* Responsive grid for files */
            gap: 16px;
        }
        .file-list {
            display: flex;
            flex-direction: column;
            gap: 8px; /* Smaller gap for list items */
        }

        .file-item, .folder-item {
            background-color: white;
            border: 1px solid #dadce0;
            border-radius: 8px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            position: relative; /* For star icon positioning */
        }
        /* Style for file/folder items in list view */
        .file-item.list-view-item, .folder-item.list-view-item {
            flex-direction: row; /* Arrange icon, name, date in a row */
            align-items: center;
            padding: 12px 16px; /* Adjust padding for list view */
            box-shadow: none; /* Remove shadow for a flatter list look */
            border-bottom: 1px solid #eee; /* Light line separator */
            border-radius: 0; /* No rounded corners for list items */
        }
        .file-item.list-view-item:first-child, .folder-item.list-view-item:first-child {
             border-top-left-radius: 8px;
             border-top-right-radius: 8px;
        }
        .file-item.list-view-item:last-child, .folder-item.list-view-item:last-child {
             border-bottom-left-radius: 8px;
             border-bottom-right-radius: 8px;
        }

        .file-item:hover, .folder-item:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-color: #a8d5ff; /* Light blue border on hover */
        }
        .file-item.list-view-item:hover, .folder-item.list-view-item:hover {
             background-color: #f0f4f9; /* Lighter background on hover for list items */
             border-color: #a8d5ff;
             box-shadow: none; /* Keep shadow off */
        }


        /* Ensure text ellipsis for names in both views */
        .file-item .file-name, .folder-item .folder-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%; /* Ensure it takes full width for truncation to work */
        }
        .file-item.list-view-item .file-name, .folder-item.list-view-item .file-name {
            flex-grow: 1; /* Allow name to take available space */
            margin-left: 12px; /* Space between icon and name */
            margin-right: 12px;
        }
        .file-item.list-view-item .modified-date, .folder-item.list-view-item .modified-date {
            flex-shrink: 0; /* Prevent date from shrinking */
            margin-left: auto; /* Push to the right */
        }

        .file-item .star-icon {
            position: absolute;
            top: 8px;
            right: 8px;
            cursor: pointer;
            z-index: 10; /* Ensure it's above other content */
            padding: 4px; /* Make it easier to click */
            border-radius: 4px;
            transition: background-color 0.1s ease-in-out;
        }
        .file-item .star-icon:hover {
            background-color: rgba(0,0,0,0.05);
        }
        .file-item.list-view-item .star-icon {
            position: static; /* Remove absolute positioning in list view */
            margin-left: 10px; /* Space from date */
            margin-right: -4px; /* Adjust for padding */
        }


        .new-button {
            background-color: white;
            color: #1a73e8; /* Google blue */
            box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06);
            transition: all 0.2s ease-in-out;
        }
        .new-button:hover {
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            background-color: #f0f4f9; /* Lighter blue on hover */
        }
        .sidebar-item.active {
            background-color: #e8f0fe; /* Light blue for active item */
            color: #1a73e8; /* Google blue */
        }
        .sidebar-item.active svg {
            color: #1a73e8; /* Google blue for icon */
        }
        /* Custom scrollbar for main content area */
        .main-content-scroll {
            overflow-y: auto;
            scrollbar-width: thin; /* Firefox */
            scrollbar-color: #cbd5e0 #edf2f7; /* thumb and track color */
        }
        .main-content-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .main-content-scroll::-webkit-scrollbar-track {
            background: #edf2f7; /* Light background for the track */
            border-radius: 10px;
        }
        .main-content-scroll::-webkit-scrollbar-thumb {
            background-color: #cbd5e0; /* Gray for the thumb */
            border-radius: 10px;
            border: 2px solid #edf2f7; /* Padding around the thumb */
        }

        /* Responsive adjustments for smaller screens */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
            }
            .flex-container {
                flex-direction: column;
            }
            .header {
                padding: 12px 16px;
            }
            .header .search-bar {
                width: 100%;
                margin-right: 0;
                margin-bottom: 12px;
            }
            .header .flex {
                flex-direction: column;
                align-items: stretch;
            }
            .header .flex > div {
                margin-bottom: 8px;
            }
            .new-button {
                width: 100%;
                justify-content: center;
            }
            .sidebar-nav {
                display: flex;
                flex-wrap: wrap;
                justify-content: space-around;
                padding: 8px;
            }
            .sidebar-item {
                flex: 1 1 45%; /* Two items per row */
                margin: 4px;
                padding: 8px;
                text-align: center;
                justify-content: center;
            }
            .main-content {
                padding: 16px;
            }
            .file-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); /* Smaller grid items */
            }
            .file-item.list-view-item, .folder-item.list-view-item {
                padding: 10px; /* Adjust padding for smaller list items */
            }
        }

        /* Message Box Styling */
        .message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            font-size: 0.9rem;
        }
        .message-box.show {
            opacity: 1;
        }

        /* Admin Panel Styling */
        .admin-panel-overlay, .content-viewer-overlay, .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .admin-panel-overlay.show, .content-viewer-overlay.show, .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .admin-panel-content, .content-viewer-content {
            background-color: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 400px;
            position: relative;
        }
        .admin-panel-content input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 1rem;
        }
        .admin-panel-content button {
            padding: 10px 18px;
            border-radius: 8px;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out;
        }
        .admin-panel-content .btn-primary {
            background-color: #1a73e8;
            color: white;
            margin-right: 12px;
        }
        .admin-panel-content .btn-primary:hover {
            background-color: #1764cb;
        }
        .admin-panel-content .btn-secondary {
            background-color: #f0f0f0;
            color: #333;
        }
        .admin-panel-content .btn-secondary:hover {
            background-color: #e0e0e0;
        }
        .admin-panel-close, .content-viewer-close {
            position: absolute;
            top: 12px;
            right: 12px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background-color 0.2s ease-in-out;
        }
        .admin-panel-close:hover, .content-viewer-close:hover {
            background-color: #f0f0f0;
        }

        .content-viewer-content {
            max-width: 600px; /* Wider for content viewing */
            max-height: 80vh; /* Max height to allow scrolling */
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .content-viewer-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        .content-viewer-header h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
        }
        .content-viewer-body {
            flex-grow: 1;
            padding: 10px 0;
            color: #555;
            line-height: 1.6;
        }

        .loading-content {
            background-color: white;
            padding: 32px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            text-align: center;
            font-size: 1.2rem;
            color: #333;
        }
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- Overall Container -->
    <div class="flex flex-1 overflow-hidden flex-container">

        <!-- Sidebar -->
        <aside class="sidebar h-full p-4 flex flex-col items-start">
            <div class="mb-6 w-full">
                <!-- Removed the "New" button -->
            </div>

            <nav class="sidebar-nav w-full">
                <a href="#" data-section="my-drive" class="sidebar-item flex items-center px-4 py-2 rounded-lg text-gray-700 text-sm font-medium hover:bg-gray-100 active">
                    <i data-lucide="hard-drive" class="w-5 h-5 mr-3 text-gray-500"></i>
                    My Drive
                </a>
                <a href="#" data-section="shared-with-me" class="sidebar-item flex items-center px-4 py-2 rounded-lg text-gray-700 text-sm font-medium hover:bg-gray-100">
                    <i data-lucide="users" class="w-5 h-5 mr-3 text-gray-500"></i>
                    Shared with me
                </a>
                <a href="#" data-section="starred" class="sidebar-item flex items-center px-4 py-2 rounded-lg text-gray-700 text-sm font-medium hover:bg-gray-100">
                    <i data-lucide="star" class="w-5 h-5 mr-3 text-gray-500"></i>
                    Starred
                </a>
                <a href="#" data-section="recent" class="sidebar-item flex items-center px-4 py-2 rounded-lg text-gray-700 text-sm font-medium hover:bg-gray-100">
                    <i data-lucide="clock" class="w-5 h-5 mr-3 text-gray-500"></i>
                    Recent
                </a>
                <!-- Removed the "Synapse" link from here -->
            </nav>

            <div class="mt-auto pt-6 border-t border-gray-200 w-full">
                <!-- Removed the storage section completely -->
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 flex flex-col main-content-scroll">
            <!-- Header for Main Content -->
            <header class="header p-4 flex items-center justify-between">
                <div class="flex items-center w-full max-w-lg search-bar">
                    <button class="p-2 rounded-full hover:bg-gray-100 mr-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                        <i data-lucide="menu" class="w-6 h-6 text-gray-600"></i>
                    </button>
                    <img src="https://fonts.gstatic.com/s/i/productlogos/drive_2020q4/v8/drive_2020q4_64dp.png" alt="Synapse Logo" class="h-8 w-8 mr-2">
                    <span class="text-xl font-medium text-gray-700 hidden sm:block">Synapse</span>
                    <div class="relative flex-1 ml-4">
                        <input type="text" id="search-input" placeholder="Search in Synapse" class="w-full py-2 pl-12 pr-4 rounded-full bg-gray-100 border border-gray-300 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                        <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-500"></i>
                    </div>
                </div>

                <div class="flex items-center space-x-4">
                    <button class="p-2 rounded-full hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                        <i data-lucide="help-circle" class="w-6 h-6 text-gray-600"></i>
                    </button>
                    <button class="p-2 rounded-full hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                        <i data-lucide="cog" class="w-6 h-6 text-gray-600"></i>
                    </button>
                    <button id="view-toggle-button" class="p-2 rounded-full hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                        <i data-lucide="layout-grid" class="w-6 h-6 text-gray-600"></i>
                    </button>
                    <button class="p-2 rounded-full hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                        <i data-lucide="apps" class="w-6 h-6 text-gray-600"></i>
                    </button>
                    <img src="https://placehold.co/40x40/FF5733/FFFFFF?text=A" alt="User Avatar" class="w-10 h-10 rounded-full cursor-pointer border-2 border-transparent hover:border-blue-500">
                </div>
            </header>

            <!-- Main Content Display -->
            <div id="main-content-display" class="p-6 flex-1 overflow-y-auto">
                <h2 id="current-section-title" class="text-xl font-medium text-gray-800 mb-6">My Drive</h2>
                <p id="user-id-display" class="text-sm text-gray-500 mb-4">User ID: Local Session</p>

                <!-- Breadcrumbs for folder navigation -->
                <div id="breadcrumbs" class="mb-4 text-sm text-gray-600 flex items-center hidden">
                    <!-- Breadcrumb items will be populated by JS -->
                </div>

                <!-- Content will be dynamically loaded here -->
                <div id="folders-container" class="mb-8">
                    <h3 class="text-sm font-semibold text-gray-500 uppercase mb-4">Folders</h3>
                    <div class="file-grid" id="folder-grid">
                        <!-- Folders will be rendered here by JS -->
                    </div>
                </div>

                <div id="files-container">
                    <h3 class="text-sm font-semibold text-gray-500 uppercase mb-4">Files</h3>
                    <div class="file-grid" id="file-grid">
                        <!-- Files will be rendered here by JS -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Message Box -->
    <div id="message-box" class="message-box"></div>

    <!-- Admin Panel Modal -->
    <div id="admin-panel" class="admin-panel-overlay">
        <div class="admin-panel-content">
            <button id="close-admin-panel" class="admin-panel-close">
                <i data-lucide="x" class="w-6 h-6 text-gray-600"></i>
            </button>
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Admin Panel: Create/Upload Item</h3>

            <!-- Option to create a file by typing name -->
            <div class="mb-4">
                <p class="text-sm font-medium text-gray-700 mb-2">Create new file/folder (Type name):</p>
                <input type="text" id="item-name-input" placeholder="Enter item name (e.g., New Document.docx)">
                <div class="flex justify-end mt-2">
                    <button id="create-dummy-file-btn" class="btn-secondary flex items-center px-4 py-2 mr-2">
                        <i data-lucide="file-plus" class="w-4 h-4 mr-2"></i> Create Dummy File
                    </button>
                    <button id="create-folder-btn" class="btn-primary flex items-center px-4 py-2">
                        <i data-lucide="folder-plus" class="w-4 h-4 mr-2"></i> Create Folder
                    </button>
                </div>
            </div>

            <hr class="my-4 border-gray-200">

            <!-- Option to upload a file from computer -->
            <div>
                <p class="text-sm font-medium text-gray-700 mb-2">Upload file from computer:</p>
                <input type="file" id="file-upload-input" class="hidden">
                <div class="flex items-center mb-4">
                    <button id="select-file-btn" class="btn-secondary flex items-center px-4 py-2 mr-2">
                        <i data-lucide="upload" class="w-4 h-4 mr-2"></i> Select File to Upload
                    </button>
                    <span id="selected-file-name" class="text-sm text-gray-600 truncate">No file selected</span>
                </div>
                <div class="flex justify-end">
                    <button id="upload-file-btn" class="btn-primary flex items-center px-4 py-2" disabled>
                        <i data-lucide="cloud-upload" class="w-4 h-4 mr-2"></i> Upload Selected File
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Content Viewer Modal -->
    <div id="content-viewer" class="content-viewer-overlay">
        <div class="content-viewer-content">
            <div class="content-viewer-header">
                <h3 id="content-viewer-title">
                    <i id="content-viewer-icon" class="w-6 h-6 mr-2"></i>
                    <span></span>
                </h3>
                <button id="close-content-viewer" class="content-viewer-close">
                    <i data-lucide="x" class="w-6 h-6 text-gray-600"></i>
                </button>
            </div>
            <div class="flex justify-end gap-2 mb-4">
                <button id="summarize-content-btn" class="hidden px-4 py-2 rounded-lg text-blue-700 text-sm font-medium border border-blue-700 hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                    <i data-lucide="sparkles" class="w-4 h-4 inline-block mr-1"></i> Summarize Content
                </button>
                <button id="generate-more-content-btn" class="hidden px-4 py-2 rounded-lg text-purple-700 text-sm font-medium border border-purple-700 hover:bg-purple-50 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50">
                    <i data-lucide="zap" class="w-4 h-4 inline-block mr-1"></i> Generate More Content
                </button>
                <button id="show-original-content-btn" class="hidden px-4 py-2 rounded-lg text-gray-700 text-sm font-medium border border-gray-400 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50">
                    Show Original
                </button>
            </div>
            <div id="content-viewer-body" class="content-viewer-body">
                <!-- Content will be loaded here -->
            </div>
            <div id="content-viewer-loading" class="hidden text-center text-gray-500 mt-4">
                <i data-lucide="loader-circle" class="w-6 h-6 animate-spin inline-block mr-2"></i> Loading...
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay show">
        <div class="loading-content">
            Loading your Synapse...
        </div>
    </div>

    <script type="module">
        // NO FIREBASE IMPORTS needed for local-only version

        // Helper to generate unique IDs for local data
        function generateUniqueId() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Initialize Lucide Icons after the DOM is loaded
        document.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons();

            const sidebarItems = document.querySelectorAll('.sidebar-item');
            const searchInput = document.getElementById('search-input');
            const currentSectionTitle = document.getElementById('current-section-title');
            const folderGrid = document.getElementById('folder-grid');
            const fileGrid = document.getElementById('file-grid');
            const messageBox = document.getElementById('message-box');
            const userIdDisplay = document.getElementById('user-id-display');
            const breadcrumbsContainer = document.getElementById('breadcrumbs');
            const viewToggleButton = document.getElementById('view-toggle-button');


            // Admin Panel Elements
            const adminPanel = document.getElementById('admin-panel');
            const closeAdminPanelBtn = document.getElementById('close-admin-panel');
            const itemNameInput = document.getElementById('item-name-input');
            const createDummyFileBtn = document.getElementById('create-dummy-file-btn');
            const createFolderBtn = document.getElementById('create-folder-btn');
            const fileUploadInput = document.getElementById('file-upload-input');
            const selectFileBtn = document.getElementById('select-file-btn');
            const selectedFileNameSpan = document.getElementById('selected-file-name');
            const uploadFileBtn = document.getElementById('upload-file-btn');

            // Content Viewer Elements
            const contentViewer = document.getElementById('content-viewer');
            const closeContentViewerBtn = document.getElementById('close-content-viewer');
            const contentViewerTitleSpan = document.querySelector('#content-viewer-title span');
            const contentViewerIcon = document.getElementById('content-viewer-icon');
            const contentViewerBody = document.getElementById('content-viewer-body');
            const summarizeContentBtn = document.getElementById('summarize-content-btn');
            const generateMoreContentBtn = document.getElementById('generate-more-content-btn');
            const showOriginalContentBtn = document.getElementById('show-original-content-btn');
            const contentViewerLoading = document.getElementById('content-viewer-loading');


            // Loading Overlay
            const loadingOverlay = document.getElementById('loading-overlay');

            // --- LOCAL DATA STORAGE ---
            let allFolders = [];
            let allFiles = [];

            // Folder navigation state
            let currentParentFolderId = null; // ID of the folder currently being viewed (null for root)
            let currentPath = [{ name: 'My Drive', id: null }]; // For breadcrumbs

            let isListView = false; // State for view mode: false for grid, true for list

            // New global variables for content viewer state
            let currentViewerItem = null;
            let originalContent = '';

            let typedSequence = '';
            const adminPanelTrigger = 'barneyadminpanel';
            let sequenceTimeout;
            let currentSection = 'my-drive'; // Default active section (used by sidebar)


            // Simulate data loading and setup
            async function initializeAppData() {
                userIdDisplay.textContent = `User ID: Local Session`; // Static user ID
                await ensureEaglercraftContent(); // Populate initial data
                // Immediately render content since there's no async Firestore listener
                if (currentSection === 'my-drive') {
                    renderMyDriveContent();
                } else {
                    handleSidebarNavigation(currentSection);
                }
                loadingOverlay.classList.remove('show');
            }


            // --- Utility Functions ---

            // Show a transient message
            function showMessage(message, duration = 3000) {
                messageBox.textContent = message;
                messageBox.classList.add('show');
                setTimeout(() => {
                    messageBox.classList.remove('show');
                }, duration);
            }

            // Get icon and color based on file extension
            function getFileIconAndColor(fileName) {
                let icon = 'file'; // Default generic file icon
                let color = 'text-gray-500'; // Default color
                const extMatch = fileName.match(/\.([0-9a-z]+)(?:[\?#]|$)/i);
                if (extMatch) {
                    const ext = extMatch[1].toLowerCase();
                    switch(ext) {
                        case 'docx': icon = 'file-text'; color = 'text-blue-600'; break;
                        case 'xlsx': icon = 'sheet'; color = 'text-green-600'; break;
                        case 'pptx': icon = 'presentation'; color = 'text-orange-600'; break;
                        case 'pdf': icon = 'file-text'; color = 'text-red-600'; break;
                        case 'jpg':
                        case 'jpeg':
                        case 'png':
                        case 'gif': icon = 'image'; color = 'text-purple-600'; break;
                        case 'js':
                        case 'html':
                        case 'css': icon = 'code'; color = 'text-gray-700'; break;
                        case 'txt': icon = 'file-text'; color = 'text-gray-500'; break;
                        case 'zip':
                        case 'rar': icon = 'archive'; color = 'text-yellow-600'; break;
                        case 'mp3':
                        case 'wav': icon = 'music'; color = 'text-pink-600'; break;
                        case 'mp4':
                        case 'avi': icon = 'video'; color = 'text-teal-600'; break;
                        default: break;
                    }
                }
                return { icon, color };
            }

            // --- Admin Panel Functions ---
            function showAdminPanel() {
                adminPanel.classList.add('show');
                itemNameInput.focus();
                lucide.createIcons(); // Re-initialize Lucide icons
                // Reset file upload state when panel opens
                selectedFile = null;
                fileUploadInput.value = '';
                selectedFileNameSpan.textContent = 'No file selected';
                uploadFileBtn.disabled = true;
            }

            function hideAdminPanel() {
                adminPanel.classList.remove('show');
                itemNameInput.value = ''; // Clear input on close
                selectedFile = null;
                fileUploadInput.value = '';
                selectedFileNameSpan.textContent = 'No file selected';
                uploadFileBtn.disabled = true;
            }

            // --- Content Viewer Functions ---
            function openContentViewer(item) {
                if (item.type === 'redirect-file' && item.redirectUrl) {
                    window.open(item.redirectUrl, '_blank'); // Open in new tab
                    showMessage(`Redirecting to ${item.name}!`);
                    return; // Don't show modal for redirect files
                }

                currentViewerItem = item; // Store the current item
                originalContent = item.content || `This is content for ${item.name}.`; // Fallback dummy content

                contentViewerTitleSpan.textContent = item.name;
                contentViewerIcon.setAttribute('data-lucide', item.icon);
                contentViewerIcon.className = `w-6 h-6 mr-2 ${item.color || 'text-gray-500'}`;

                // Show original content by default
                displayContentInViewer(originalContent);
                showOriginalContentBtn.classList.add('hidden'); // Hide original button when showing original

                // Show/hide AI buttons based on item type and content existence
                if (item.type === 'file' || item.type === 'redirect-file') { // Treat redirect-file also as something with "content" in this context
                    summarizeContentBtn.classList.remove('hidden');
                    generateMoreContentBtn.classList.remove('hidden');
                } else {
                    summarizeContentBtn.classList.add('hidden');
                    generateMoreContentBtn.classList.add('hidden');
                }

                contentViewer.classList.add('show');
                lucide.createIcons();
            }

            function displayContentInViewer(content) {
                contentViewerBody.innerHTML = `<p class="whitespace-pre-wrap">${content}</p>`;
            }

            function closeContentViewer() {
                contentViewer.classList.remove('show');
                currentViewerItem = null;
                originalContent = '';
                summarizeContentBtn.classList.add('hidden');
                generateMoreContentBtn.classList.add('hidden');
                showOriginalContentBtn.classList.add('hidden');
            }

            // Function to make Gemini API call with exponential backoff
            async function callGeminiApi(prompt, retries = 3, delay = 1000) {
                contentViewerLoading.classList.remove('hidden'); // Show loading indicator
                for (let i = 0; i < retries; i++) {
                    try {
                        let chatHistory = [];
                        chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                        const payload = { contents: chatHistory };
                        const apiKey = ""; // Canvas will automatically provide it
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            // If not ok, throw error to trigger retry or final catch
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const result = await response.json();

                        if (result.candidates && result.candidates.length > 0 &&
                            result.candidates[0].content && result.candidates[0].content.parts &&
                            result.candidates[0].content.parts.length > 0) {
                            return result.candidates[0].content.parts[0].text;
                        } else {
                            throw new Error('Gemini API response structure unexpected or content missing.');
                        }
                    } catch (error) {
                        console.error(`Attempt ${i + 1} failed:`, error);
                        if (i < retries - 1) {
                            await new Promise(res => setTimeout(res, delay));
                            delay *= 2; // Exponential backoff
                        } else {
                            throw error; // Rethrow after final attempt
                        }
                    }
                }
            }

            // Event listener for Summarize button
            summarizeContentBtn.addEventListener('click', async () => {
                if (!currentViewerItem || !currentViewerItem.content) {
                    showMessage("No content to summarize.", 3000);
                    return;
                }

                showOriginalContentBtn.classList.remove('hidden'); // Show button to go back to original
                summarizeContentBtn.classList.add('hidden'); // Hide summarize button after click
                generateMoreContentBtn.classList.add('hidden'); // Hide generate button during summarization

                try {
                    const summary = await callGeminiApi(`Summarize the following content concisely: ${currentViewerItem.content}`);
                    displayContentInViewer(summary);
                    showMessage("Content summarized by Gemini! âœ¨", 3000);
                } catch (error) {
                    console.error("Error summarizing content:", error);
                    displayContentInViewer("Failed to summarize content. Please try again later.");
                    showMessage("Error summarizing content. ðŸ˜ž", 5000);
                } finally {
                    contentViewerLoading.classList.add('hidden'); // Hide loading indicator
                }
            });

            // Event listener for Generate More Content button
            generateMoreContentBtn.addEventListener('click', async () => {
                if (!currentViewerItem || !currentViewerItem.content) {
                    showMessage("No original content to build upon.", 3000);
                    return;
                }

                showOriginalContentBtn.classList.remove('hidden'); // Show button to go back to original
                summarizeContentBtn.classList.add('hidden'); // Hide summarize button during generation
                generateMoreContentBtn.classList.add('hidden'); // Hide generate button after click

                try {
                    const newContent = await callGeminiApi(`Expand on the following content, adding more detail and depth: "${currentViewerItem.content}"`);
                    displayContentInViewer(newContent);
                    showMessage("More content generated by Gemini! âœ¨", 3000);
                } catch (error) {
                    console.error("Error generating more content:", error);
                    displayContentInViewer("Failed to generate more content. Please try again later.");
                    showMessage("Error generating more content. ðŸ˜ž", 5000);
                } finally {
                    contentViewerLoading.classList.add('hidden'); // Hide loading indicator
                }
            });

            // Event listener for Show Original Content button
            showOriginalContentBtn.addEventListener('click', () => {
                if (currentViewerItem) {
                    displayContentInViewer(originalContent);
                    showOriginalContentBtn.classList.add('hidden'); // Hide itself
                    summarizeContentBtn.classList.remove('hidden'); // Show summarize button
                    generateMoreContentBtn.classList.remove('hidden'); // Show generate button
                }
            });


            // Function to toggle starred status in local data
            function toggleStarredStatus(fileId, currentStarredStatus) {
                const fileIndex = allFiles.findIndex(f => f.id === fileId);
                if (fileIndex > -1) {
                    allFiles[fileIndex].isStarred = !currentStarredStatus;
                    allFiles[fileIndex].modified = new Date(); // Update modified timestamp
                    showMessage(`File ${!currentStarredStatus ? 'starred' : 'unstarred'}! (Local change)`);
                    // Re-render the current view to reflect the change
                    if (currentSection === 'my-drive') {
                        renderMyDriveContent();
                    } else {
                        handleSidebarNavigation(currentSection);
                    }
                }
            }


            // --- Render Content for Current Folder in My Drive ---
            function renderMyDriveContent() {
                // Update header title based on current folder
                currentSectionTitle.textContent = currentPath[currentPath.length - 1].name;
                updateBreadcrumbs();
                breadcrumbsContainer.classList.remove('hidden'); // Show breadcrumbs

                const foldersToRender = allFolders.filter(f => f.parentId === currentParentFolderId);
                const filesToRender = allFiles.filter(f => f.parentId === currentParentFolderId);

                // Apply correct class for grid/list view to the containers
                folderGrid.classList.toggle('file-list', isListView);
                folderGrid.classList.toggle('file-grid', !isListView);
                fileGrid.classList.toggle('file-list', isListView);
                fileGrid.classList.toggle('file-grid', !isListView);


                folderGrid.innerHTML = '';
                fileGrid.innerHTML = '';

                if (foldersToRender.length === 0 && filesToRender.length === 0) {
                    fileGrid.innerHTML = '<p class="text-gray-500">No items found in this folder.</p>';
                    document.getElementById('folders-container').style.display = 'block';
                    document.getElementById('files-container').style.display = 'block';
                } else {
                    if (foldersToRender.length > 0) {
                        document.getElementById('folders-container').style.display = 'block';
                        foldersToRender.forEach(folder => {
                            const modifiedDate = folder.modified instanceof Date
                                ? folder.modified.toLocaleString()
                                : 'N/A';
                            const folderDiv = document.createElement('div');
                            folderDiv.className = `folder-item ${isListView ? 'list-view-item' : ''}`;
                            folderDiv.innerHTML = `
                                <i data-lucide="${folder.icon}" class="w-6 h-6 text-blue-500 ${isListView ? '' : 'mb-2'}"></i>
                                <span class="text-sm font-medium text-gray-800 file-name">${folder.name}</span>
                                <span class="text-xs text-gray-500 ${isListView ? 'modified-date' : 'mt-1'}">Modified ${modifiedDate}</span>
                            `;
                            folderDiv.onclick = () => {
                                console.log("Folder clicked:", folder.name); // Debug log
                                currentParentFolderId = folder.id;
                                currentPath.push({ name: folder.name, id: folder.id });
                                renderMyDriveContent(); // Recurse to render contents of the new folder
                            };
                            folderGrid.appendChild(folderDiv);
                        });
                    } else {
                        document.getElementById('folders-container').style.display = 'none';
                    }

                    if (filesToRender.length > 0) {
                        document.getElementById('files-container').style.display = 'block';
                        filesToRender.forEach(file => {
                            const modifiedDate = file.modified instanceof Date
                                ? file.modified.toLocaleString()
                                : 'N/A';
                            const fileDiv = document.createElement('div');
                            fileDiv.className = `file-item ${isListView ? 'list-view-item' : ''}`;
                            fileDiv.innerHTML = `
                                <i data-lucide="${file.icon}" class="w-6 h-6 ${file.color || 'text-gray-500'} ${isListView ? '' : 'mb-2'}"></i>
                                <span class="text-sm font-medium text-gray-800 file-name">${file.name}</span>
                                <span class="text-xs text-gray-500 ${isListView ? 'modified-date' : 'mt-1'}">Modified ${modifiedDate}</span>
                                <i data-lucide="star" class="star-icon w-5 h-5 ${file.isStarred ? 'text-yellow-400' : 'text-gray-400'}"></i>
                            `;
                            // Star icon click handler
                            const starIcon = fileDiv.querySelector('.star-icon');
                            starIcon.addEventListener('click', (e) => {
                                e.stopPropagation(); // Prevent parent item's click event
                                toggleStarredStatus(file.id, file.isStarred);
                            });

                            // File item click handler (excluding star)
                            fileDiv.addEventListener('click', (e) => {
                                // Only open content viewer if the star icon was not clicked
                                if (!e.target.closest('.star-icon')) {
                                    console.log("File clicked:", file.name); // Debug log
                                    openContentViewer(file);
                                }
                            });
                            fileGrid.appendChild(fileDiv);
                        });
                    } else {
                        document.getElementById('files-container').style.display = 'none';
                    }
                }
                lucide.createIcons(); // Ensure icons for newly rendered items are created
            }

            // Function to update breadcrumbs
            function updateBreadcrumbs() {
                breadcrumbsContainer.innerHTML = ''; // Clear existing breadcrumbs

                currentPath.forEach((pathItem, index) => {
                    const span = document.createElement('span');
                    if (index > 0) {
                        const separator = document.createElement('span');
                        separator.className = 'mx-2 text-gray-400';
                        separator.textContent = '>';
                        breadcrumbsContainer.appendChild(separator);
                    }
                    const link = document.createElement('a');
                    link.href = '#';
                    link.className = 'hover:underline';
                    if (index === currentPath.length - 1) { // Last item in path is not a link
                        link.className += ' text-gray-800 cursor-default no-underline';
                        link.onclick = (e) => e.preventDefault(); // Disable click for current folder
                    } else {
                        link.className += ' text-blue-600';
                        link.onclick = (e) => {
                            e.preventDefault();
                            // Navigate up to this path item
                            currentPath.splice(index + 1); // Remove subsequent path items
                            currentParentFolderId = pathItem.id;
                            renderMyDriveContent();
                        };
                    }
                    link.textContent = pathItem.name;
                    breadcrumbsContainer.appendChild(link);
                });
            }

            // --- Handles sidebar navigation (My Drive, Shared, Starred, Recent) ---
            function handleSidebarNavigation(section) {
                currentSection = section; // Update global currentSection
                searchInput.value = ''; // Reset search input

                // Reset My Drive view if navigating from another section to My Drive
                if (section === 'my-drive') {
                    currentParentFolderId = null; // Reset to root
                    currentPath = [{ name: 'My Drive', id: null }]; // Reset breadcrumbs
                    renderMyDriveContent(); // Render My Drive's hierarchical content
                    return; // Exit, as My Drive rendering is handled separately
                }

                // For other sections (Shared, Starred, Recent), treat them as flat lists
                breadcrumbsContainer.classList.add('hidden'); // Hide breadcrumbs for flat views
                let foldersToShow = [];
                let filesToShow = [];
                let title = '';

                switch (section) {
                    case 'shared-with-me':
                        title = 'Shared with me';
                        filesToShow = allFiles.filter(f => f.name.includes('Report') || f.name.includes('Budget')).slice(0, 3);
                        foldersToShow = [];
                        break;
                    case 'starred':
                        title = 'Starred';
                        filesToShow = allFiles.filter(f => f.isStarred); // Filter for starred files from local array
                        foldersToShow = []; // Starred only applies to files here
                        break;
                    case 'recent':
                        title = 'Recent';
                        filesToShow = [...allFiles].sort((a, b) => (b.modified.getTime() || 0) - (a.modified.getTime() || 0)).slice(0, 5);
                        foldersToShow = [...allFolders].sort((a, b) => (b.modified.getTime() || 0) - (a.modified.getTime() || 0)).slice(0, 2);
                        break;
                    default:
                        title = 'Unknown Section';
                        break;
                }

                currentSectionTitle.textContent = title;
                renderFlatContent(foldersToShow, filesToShow);
            }

            // A helper function to render content for flat sections (non-My Drive)
            function renderFlatContent(foldersToRender, filesToRender) {
                // Apply correct class for grid/list view to the containers
                folderGrid.classList.toggle('file-list', isListView);
                folderGrid.classList.toggle('file-grid', !isListView);
                fileGrid.classList.toggle('file-list', isListView);
                fileGrid.classList.toggle('file-grid', !isListView);


                folderGrid.innerHTML = '';
                fileGrid.innerHTML = '';

                if (foldersToRender.length === 0 && filesToRender.length === 0) {
                    fileGrid.innerHTML = '<p class="text-gray-500">No items found in this section.</p>';
                    document.getElementById('folders-container').style.display = 'block';
                    document.getElementById('files-container').style.display = 'block';
                } else {
                    if (foldersToRender.length > 0) {
                        document.getElementById('folders-container').style.display = 'block';
                        foldersToRender.forEach(folder => {
                            const modifiedDate = folder.modified instanceof Date
                                ? folder.modified.toLocaleString()
                                : 'N/A';
                            const folderDiv = document.createElement('div');
                            folderDiv.className = `folder-item ${isListView ? 'list-view-item' : ''}`;
                            folderDiv.innerHTML = `
                                <i data-lucide="${folder.icon}" class="w-6 h-6 text-blue-500 ${isListView ? '' : 'mb-2'}"></i>
                                <span class="text-sm font-medium text-gray-800 file-name">${folder.name}</span>
                                <span class="text-xs text-gray-500 ${isListView ? 'modified-date' : 'mt-1'}">Modified ${modifiedDate}</span>
                            `;
                            folderDiv.onclick = () => {
                                console.log("Folder clicked (flat view):", folder.name); // Debug log
                                showMessage(`Folder clicked (in ${currentSection}): ${folder.name}`); // Just show message for non-My Drive folders
                            };
                            folderGrid.appendChild(folderDiv);
                        });
                    } else {
                        document.getElementById('folders-container').style.display = 'none';
                    }

                    if (filesToRender.length > 0) {
                        document.getElementById('files-container').style.display = 'block';
                        filesToRender.forEach(file => {
                            const modifiedDate = file.modified instanceof Date
                                ? file.modified.toLocaleString()
                                : 'N/A';
                            const fileDiv = document.createElement('div');
                            fileDiv.className = `file-item ${isListView ? 'list-view-item' : ''}`;
                            fileDiv.innerHTML = `
                                <i data-lucide="${file.icon}" class="w-6 h-6 ${file.color || 'text-gray-500'} ${isListView ? '' : 'mb-2'}"></i>
                                <span class="text-sm font-medium text-gray-800 file-name">${file.name}</span>
                                <span class="text-xs text-gray-500 ${isListView ? 'modified-date' : 'mt-1'}">Modified ${modifiedDate}</span>
                                <i data-lucide="star" class="star-icon w-5 h-5 ${file.isStarred ? 'text-yellow-400' : 'text-gray-400'}"></i>
                            `;
                            // Star icon click handler
                            const starIcon = fileDiv.querySelector('.star-icon');
                            starIcon.addEventListener('click', (e) => {
                                e.stopPropagation(); // Prevent parent item's click event
                                toggleStarredStatus(file.id, file.isStarred);
                            });

                            fileDiv.onclick = (e) => {
                                if (!e.target.closest('.star-icon')) {
                                    console.log("File clicked (flat view):", file.name); // Debug log
                                    openContentViewer(file);
                                }
                            };
                            fileGrid.appendChild(fileDiv);
                        });
                    } else {
                        document.getElementById('files-container').style.display = 'none';
                    }
                }
                lucide.createIcons();
            }

            // Function to populate initial data (replaces Firebase data fetching)
            async function ensureEaglercraftContent() {
                let eaglercraftFolder = allFolders.find(f => f.name === 'eaglercraft' && f.parentId === null);

                if (!eaglercraftFolder) {
                    eaglercraftFolder = {
                        id: generateUniqueId(),
                        name: 'eaglercraft',
                        type: 'folder',
                        icon: 'folder',
                        modified: new Date(),
                        parentId: null
                    };
                    allFolders.push(eaglercraftFolder);
                    showMessage('Created "eaglercraft" folder.');
                }

                const eaglercraftFileRedirects = {
                    "BetterEagler USA dev-a1.html": "https://drive.google.com/file/d/1hxKmD5jsz8AoMwZFXNimnf-O022wV9WS/view",
                    "eag1_11_2 (1).html": "https://drive.google.com/file/d/1UvGn0hlX_uDwCv24VLDVmAjuf9xIPcmF/view",
                    "Eaglercraft_1.12_Offline_Download.zip": "https://drive.google.com/file/d/1sPJBrmzVI-XGIy5VZ4vRBa95IQC65OdN/view",
                    "EaglercraftX_1.8_u39_Offline_Signed.html": "https://drive.google.com/file/d/1Itk-VZH23QRrwNvZtgUwlEOzteBqakMJ/view?usp=drive_open",
                    "EaglercraftZ_1.16.5_Offline_en_US (1).html": "https://drive.google.com/file/d/1sjL7Z-lsp1VILuc8Qf3kujsJW3XV3OOo/view",
                    "EaglercraftZ_1.16.5_Offline_en_US.html": "https://drive.google.com/file/d/1m9ToVjbYLoW06Y1jxQW8vS8ZMQ6mBPa6/view",
                    "EaglerForge v1.3.2.html": "https://drive.google.com/file/d/1MDGGLDdmXnMlijzcVP0USKc9Qi5GX-zX/view",
                    "EaglerForge v1.html": "https://drive.google.com/file/d/1Ogt2JHjc1wT1CdcNc4FBvnDQ-XaJMA0L/view",
                    "EaglyMC u6.html": "https://drive.google.com/file/d/1IKwYWe4YhcbaNwdqbM570fyuxKTlJiDR/view",
                    "Prism Client 1.0.html": "https://drive.google.com/file/d/1Z_cFqH6yuuFn_vhzf0kYeTPqzbD9AjWh/view",
                    "SigmaClient-1.0.0-u40.html": "https://drive.google.com/file/d/1YksN1qatNQSaT4AxkOLunRNvQBDrSzZE/view",
                    "Starlike Client 0.4.0.html": "https://drive.google.com/file/d/1k04QmrG1C86Wwi848jDXImF6of_YU3dQ/view"
                };

                const defaultStarredFiles = [
                    "Eaglercraft_1.12_Offline_Download.zip",
                    "EaglercraftX_1.8_u39_Offline_Signed.html"
                ];

                for (const fileName in eaglercraftFileRedirects) {
                    const redirectUrl = eaglercraftFileRedirects[fileName];
                    const fileExists = allFiles.some(f =>
                        f.name === fileName &&
                        f.type === 'redirect-file' &&
                        f.parentId === eaglercraftFolder.id
                    );
                    const shouldBeStarred = defaultStarredFiles.includes(fileName);

                    if (!fileExists) {
                        const newFile = {
                            id: generateUniqueId(),
                            name: fileName,
                            type: 'redirect-file',
                            icon: 'link',
                            color: 'text-green-700',
                            modified: new Date(),
                            content: `This is dummy content for "${fileName}". It simulates content you might find in a file.`,
                            redirectUrl: redirectUrl, // Assign unique redirect URL
                            parentId: eaglercraftFolder.id,
                            isStarred: shouldBeStarred
                        };
                        allFiles.push(newFile);
                        showMessage(`Created "${fileName}" file.`);
                    } else {
                        // Update starred status and redirect URL if necessary for existing files
                        const existingFile = allFiles.find(f => f.name === fileName && f.parentId === eaglercraftFolder.id);
                        if (existingFile) {
                            let updated = false;
                            if (existingFile.isStarred !== shouldBeStarred) {
                                existingFile.isStarred = shouldBeStarred;
                                updated = true;
                            }
                            if (existingFile.redirectUrl !== redirectUrl) {
                                existingFile.redirectUrl = redirectUrl;
                                updated = true;
                            }
                            if (updated) {
                                existingFile.modified = new Date();
                                showMessage(`Updated "${fileName}" details.`);
                            }
                        }
                    }
                }
            }


            // --- Event Listeners ---

            // Sidebar Navigation
            sidebarItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    sidebarItems.forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    const section = item.getAttribute('data-section');
                    handleSidebarNavigation(section);
                });
            });

            // Search Input Filtering
            searchInput.addEventListener('input', () => {
                const query = searchInput.value.toLowerCase();
                if (currentSection === 'my-drive') {
                    // Search only within the current folder's contents if in My Drive
                    const filteredFolders = allFolders.filter(folder =>
                        folder.parentId === currentParentFolderId && folder.name.toLowerCase().includes(query)
                    );
                    const filteredFiles = allFiles.filter(file =>
                        file.parentId === currentParentFolderId && file.name.toLowerCase().includes(query)
                    );
                    renderFlatContent(filteredFolders, filteredFiles); // Use flat render for search results temporarily
                } else {
                    // For other sections, search the entire flat list
                    const filteredFolders = allFolders.filter(folder =>
                        folder.name.toLowerCase().includes(query)
                    );
                    const filteredFiles = allFiles.filter(file =>
                        file.name.toLowerCase().includes(query)
                    );
                    renderFlatContent(filteredFolders, filteredFiles);
                }
            });

            // View Toggle Button Listener
            viewToggleButton.addEventListener('click', () => {
                console.log("View toggle button clicked! Current view:", isListView ? "list" : "grid"); // Debug log
                isListView = !isListView; // Toggle the view state
                // Update the button icon by replacing innerHTML and re-creating Lucide icons
                if (isListView) {
                    viewToggleButton.innerHTML = '<i data-lucide="list" class="w-6 h-6 text-gray-600"></i>';
                } else {
                    viewToggleButton.innerHTML = '<i data-lucide="layout-grid" class="w-6 h-6 text-gray-600"></i>';
                }
                lucide.createIcons(); // Re-render icon
                // Re-render content based on the updated view
                if (currentSection === 'my-drive') {
                    renderMyDriveContent();
                } else {
                    // For other sections, re-render them in the new view style
                    handleSidebarNavigation(currentSection);
                }
            });


            // --- Admin Panel Specific Listeners ---

            // Listen for keydown events to trigger the admin panel
            document.addEventListener('keydown', (e) => {
                // Remove existing timeout to prevent reset if user is still typing
                clearTimeout(sequenceTimeout);

                typedSequence += e.key.toLowerCase();

                // Check if the typed sequence matches the trigger
                if (typedSequence.includes(adminPanelTrigger)) {
                    showAdminPanel();
                    typedSequence = ''; // Reset after opening
                } else {
                    // Set a new timeout to reset typedSequence if typing stops
                    sequenceTimeout = setTimeout(() => {
                        typedSequence = '';
                    }, 1000); // Reset after 1 second of no typing
                }

                // Allow 'Escape' key to close modals
                if (e.key === 'Escape') {
                    if (adminPanel.classList.contains('show')) {
                        hideAdminPanel();
                    }
                    if (contentViewer.classList.contains('show')) {
                        closeContentViewer();
                    }
                }
            });


            // Close admin panel button
            closeAdminPanelBtn.addEventListener('click', hideAdminPanel);

            // Create Dummy File button
            createDummyFileBtn.addEventListener('click', () => {
                const name = itemNameInput.value.trim();
                if (!name) {
                    showMessage('Please enter a name for the dummy file.');
                    return;
                }

                if (currentSection !== 'my-drive') {
                    showMessage('Dummy file creation is only supported in "My Drive". Please switch to "My Drive".');
                    return;
                }

                const { icon, color } = getFileIconAndColor(name);
                const newFile = {
                    id: generateUniqueId(),
                    name: name,
                    type: 'file',
                    icon: icon,
                    color: color,
                    modified: new Date(),
                    content: `This is dummy content for the file "${name}". No actual file data is stored.`, // Dummy content
                    parentId: currentParentFolderId, // Assign to current folder
                    isStarred: false // Initialize isStarred for new files
                };

                allFiles.push(newFile);
                showMessage(`Dummy file "${name}" created successfully! (Local storage only)`);
                renderMyDriveContent(); // Re-render to show new file
                hideAdminPanel();
            });

            // Create Folder button
            createFolderBtn.addEventListener('click', () => {
                const name = itemNameInput.value.trim();
                if (!name) {
                    showMessage('Please enter a name for the folder.');
                    return;
                }

                if (currentSection !== 'my-drive') {
                    showMessage('Folder creation is only supported in "My Drive". Please switch to "My Drive".');
                    return;
                }

                const newFolder = {
                    id: generateUniqueId(),
                    name: name,
                    type: 'folder',
                    icon: 'folder',
                    modified: new Date(),
                    parentId: currentParentFolderId // Assign to current folder
                };

                allFolders.push(newFolder);
                showMessage(`Folder "${name}" created successfully! (Local storage only)`);
                renderMyDriveContent(); // Re-render to show new folder
                hideAdminPanel();
            });

            // Trigger file input click when "Select File" button is clicked
            selectFileBtn.addEventListener('click', () => {
                fileUploadInput.click();
            });

            // Handle file selection
            fileUploadInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    selectedFile = e.target.files[0];
                    selectedFileNameSpan.textContent = selectedFile.name;
                    uploadFileBtn.disabled = false; // Enable upload button
                } else {
                    selectedFile = null;
                    selectedFileNameSpan.textContent = 'No file selected';
                    uploadFileBtn.disabled = true;
                }
            });

            // Handle actual file upload (simulated)
            uploadFileBtn.addEventListener('click', () => {
                if (!selectedFile) {
                    showMessage('Please select a file to upload.');
                    return;
                }

                if (currentSection !== 'my-drive') {
                    showMessage('File upload is only supported in "My Drive". Please switch to "My Drive".');
                    return;
                }

                const { icon, color } = getFileIconAndColor(selectedFile.name);

                const uploadedFileRecord = {
                    id: generateUniqueId(),
                    name: selectedFile.name,
                    type: 'file',
                    icon: icon,
                    color: color,
                    modified: new Date(),
                    size: selectedFile.size, // Store file size
                    content: `This is a simulated content for the uploaded file "${selectedFile.name}". It has a size of ${(selectedFile.size / 1024).toFixed(2)} KB. No actual binary data is stored.`,
                    parentId: currentParentFolderId, // Assign to current folder
                    isStarred: false // Initialize isStarred for uploaded files
                };

                allFiles.push(uploadedFileRecord);
                showMessage(`File "${selectedFile.name}" uploaded successfully! (Simulated, local storage only)`);
                renderMyDriveContent(); // Re-render to show new file
                hideAdminPanel(); // Hide after upload
            });

            // Close content viewer button
            closeContentViewerBtn.addEventListener('click', closeContentViewer);

            // Initial call to start the app
            initializeAppData();
        });
    </script>
</body>
</html>
