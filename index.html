<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Synapse</title>
    <link rel="icon" href="https://fonts.gstatic.com/s/i/productlogos/drive_2020q4/v8/drive_2020q4_48dp.png" type="image/png">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            /* Default (Pinterest-inspired Light) Theme Variables */
            --bg-primary: #F7F9FA; /* Very light gray background */
            --bg-secondary: white; /* For sidebar, header, cards */
            --text-primary: #3C4043; /* Darker gray for main text */
            --text-secondary: #70757A; /* Lighter gray for secondary text, icons */
            --border-color: #E8EAED;
            --item-border: #E8EAED;
            --item-hover-bg: #F0F4F9; /* Light hover for items */
            --sidebar-active-bg: #E8F0FE; /* Active sidebar background */
            --sidebar-active-text: #1A73E8; /* Google blue for active sidebar text/icon */
            --search-bg: #E8EAED; /* Search bar background */
            --search-border: #BDC1C6; /* Search bar border */
            --button-primary-bg: #1A73E8; /* Google blue for primary buttons */
            --button-primary-hover-bg: #1764cb;
            --button-secondary-bg: #E8EAED; /* Light gray for secondary buttons */
            --button-secondary-text: #3C4043;
            --button-secondary-hover-bg: #DCDCDE;
            --new-button-bg: #E8F0FE; /* Specific light blue for new button - matches active sidebar */
            --new-button-text: #1A73E8;
            --new-button-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06);
            --star-yellow: #f59e0b; /* Existing Tailwind yellow-400 */
            --star-gray: #9ca3af; /* Existing Tailwind gray-400 */
        }

        body.theme-drive {
            /* Drive Theme Variables (Darker, Google Drive colors) */
            --bg-primary: #1F1F1F; /* Dark background */
            --bg-secondary: #2E2E2E; /* Slightly lighter than primary for cards/header */
            --text-primary: #E0E0E0; /* Light text on dark bg */
            --text-secondary: #B0B0B0; /* Slightly dimmer light text */
            --border-color: #3A3A3A;
            --item-border: #4A4A4A;
            --item-hover-bg: #383838;
            --sidebar-active-bg: #303030;
            --sidebar-active-text: #4285F4; /* Google Blue */
            --search-bg: #3A3A3A;
            --search-border: #5A5A5A;
            --button-primary-bg: #4285F4; /* Google Blue */
            --button-primary-hover-bg: #3B72D4;
            --button-secondary-bg: #5A5A5A;
            --button-secondary-text: #E0E0E0;
            --button-secondary-hover-bg: #6A6A6A;
            --star-yellow: #FBBC04; /* Google Yellow */
            --star-gray: #777777;
            --new-button-bg: #4285F4; /* Drive theme's primary blue for new button */
            --new-button-text: white;
            --new-button-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary); /* Apply default text color */
            transition: background-color 0.3s ease, color 0.3s ease; /* Smooth theme transition */
        }
        .sidebar {
            width: 280px; /* Fixed width for the sidebar */
            flex-shrink: 0;
            background-color: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .header {
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); /* Responsive grid for files */
            gap: 16px;
        }
        .file-list {
            display: flex;
            flex-direction: column;
            gap: 8px; /* Smaller gap for list items */
        }

        .file-item, .folder-item {
            background-color: var(--bg-secondary);
            border: 1px solid var(--item-border);
            border-radius: 8px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            position: relative; /* For star icon positioning */
        }
        /* Style for file/folder items in list view */
        .file-item.list-view-item, .folder-item.list-view-item {
            flex-direction: row; /* Arrange icon, name, date in a row */
            align-items: center;
            padding: 12px 16px; /* Adjust padding for list view */
            box-shadow: none; /* Remove shadow for a flatter list look */
            border-bottom: 1px solid var(--border-color); /* Light line separator */
            border-radius: 0; /* No rounded corners for list items */
        }
        .file-item.list-view-item:first-child, .folder-item.list-view-item:first-child {
             border-top-left-radius: 8px;
             border-top-right-radius: 8px;
        }
        .file-item.list-view-item:last-child, .folder-item.list-view-item:last-child {
             border-bottom-left-radius: 8px;
             border-bottom-right-radius: 8px;
        }

        .file-item:hover, .folder-item:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-color: var(--sidebar-active-text); /* Light blue border on hover */
        }
        .file-item.list-view-item:hover, .folder-item.list-view-item:hover {
             background-color: var(--item-hover-bg); /* Lighter background on hover for list items */
             border-color: var(--sidebar-active-text);
             box-shadow: none; /* Keep shadow off */
        }


        /* Ensure text ellipsis for names in both views */
        .file-item .file-name, .folder-item .folder-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%; /* Ensure it takes full width for truncation to work */
            color: var(--text-primary);
        }
        .file-item.list-view-item .file-name, .folder-item.list-view-item .file-name {
            flex-grow: 1; /* Allow name to take available space */
            margin-left: 12px; /* Space between icon and name */
            margin-right: 12px;
        }
        .file-item.list-view-item .modified-date, .folder-item.list-view-item .modified-date {
            flex-shrink: 0; /* Prevent date from shrinking */
            margin-left: auto; /* Push to the right */
            color: var(--text-secondary);
        }

        .file-item .star-icon {
            position: absolute;
            top: 8px;
            right: 8px;
            cursor: pointer;
            z-index: 10; /* Ensure it's above other content */
            padding: 4px; /* Make it easier to click */
            border-radius: 4px;
            transition: background-color 0.1s ease-in-out;
        }
        .file-item .star-icon:hover {
            background-color: rgba(0,0,0,0.05);
        }
        .file-item.list-view-item .star-icon {
            position: static; /* Remove absolute positioning in list view */
            margin-left: 10px; /* Space from date */
            margin-right: -4px; /* Adjust for padding */
        }


        .new-button {
            background-color: var(--new-button-bg);
            color: var(--new-button-text);
            box-shadow: var(--new-button-shadow);
            transition: all 0.2s ease-in-out;
        }
        .new-button:hover {
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            filter: brightness(0.9); /* Slightly darken on hover */
        }
        .sidebar-item {
             color: var(--text-secondary);
        }
        .sidebar-item svg {
             color: var(--text-secondary); /* Default icon color */
        }

        .sidebar-item.active {
            background-color: var(--sidebar-active-bg); /* Light blue for active item */
            color: var(--sidebar-active-text); /* Google blue */
        }
        .sidebar-item.active svg {
            color: var(--sidebar-active-text); /* Google blue for icon */
        }
        /* Custom scrollbar for main content area */
        .main-content-scroll {
            overflow-y: auto;
            scrollbar-width: thin; /* Firefox */
            scrollbar-color: var(--item-border) var(--bg-primary); /* thumb and track color */
        }
        .main-content-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .main-content-scroll::-webkit-scrollbar-track {
            background: var(--bg-primary); /* Light background for the track */
            border-radius: 10px;
        }
        .main-content-scroll::-webkit-scrollbar-thumb {
            background-color: var(--item-border); /* Gray for the thumb */
            border-radius: 10px;
            border: 2px solid var(--bg-primary); /* Padding around the thumb */
        }

        /* Responsive adjustments for smaller screens */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }
            .flex-container {
                flex-direction: column;
            }
            .header {
                padding: 12px 16px;
            }
            .header .search-bar {
                width: 100%;
                margin-right: 0;
                margin-bottom: 12px;
            }
            .header .flex {
                flex-direction: column;
                align-items: stretch;
            }
            .header .flex > div {
                margin-bottom: 8px;
            }
            .new-button {
                width: 100%;
                justify-content: center;
            }
            .sidebar-nav {
                display: flex;
                flex-wrap: wrap;
                justify-content: space-around;
                padding: 8px;
            }
            .sidebar-item {
                flex: 1 1 45%; /* Two items per row */
                margin: 4px;
                padding: 8px;
                text-align: center;
                justify-content: center;
            }
            .main-content {
                padding: 16px;
            }
            .file-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); /* Smaller grid items */
            }
            .file-item.list-view-item, .folder-item.list-view-item {
                padding: 10px; /* Adjust padding for smaller list items */
            }
        }

        /* Message Box Styling */
        .message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--text-primary); /* Darker for popups */
            color: var(--bg-secondary); /* Light text on popup */
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            font-size: 0.9rem;
        }
        .message-box.show {
            opacity: 1;
        }

        /* Modal Overlays (generic for settings, content viewer, and future modals) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: var(--bg-secondary);
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 450px; /* Default width for modals */
            position: relative;
            color: var(--text-primary);
        }
        .modal-close {
            position: absolute;
            top: 12px;
            right: 12px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background-color 0.2s ease-in-out;
        }
        .modal-close:hover {
            background-color: var(--item-hover-bg);
        }


        /* Specific styles for content viewer if needed, overriding modal-content */
        #content-viewer .modal-content {
            max-width: 600px; /* Wider for content viewing */
            max-height: 80vh; /* Max height to allow scrolling */
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .content-viewer-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        .content-viewer-header h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
        }
        .content-viewer-body {
            flex-grow: 1;
            padding: 10px 0;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .loading-content {
            background-color: var(--bg-secondary);
            padding: 32px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            text-align: center;
            font-size: 1.2rem;
            color: var(--text-primary);
        }

        .search-bar input {
            background-color: var(--search-bg);
            border-color: var(--search-border);
            color: var(--text-primary);
        }
        .search-bar input:focus {
            border-color: var(--button-primary-bg);
            box-shadow: 0 0 0 1px var(--button-primary-bg);
        }
        .search-bar i {
            color: var(--text-secondary);
        }

        button.p-2.rounded-full {
            background-color: transparent; /* Ensure button background is transparent */
            transition: background-color 0.2s ease;
        }

        button.p-2.rounded-full:hover {
            background-color: var(--item-hover-bg);
        }
        button.p-2.rounded-full i {
            color: var(--text-secondary);
        }
        .sidebar-item .lucide { /* Specific style for icons inside sidebar items */
            color: var(--text-secondary);
        }
        .sidebar-item.active .lucide { /* Specific style for icons inside active sidebar items */
            color: var(--sidebar-active-text);
        }

        /* Specific styles for input and buttons within manage-content-modal */
        #manage-content-modal input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 1rem;
            background-color: var(--bg-primary); /* input background */
            color: var(--text-primary);
        }
        #manage-content-modal button {
            padding: 10px 18px;
            border-radius: 8px;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out;
        }
        #manage-content-modal .btn-primary {
            background-color: var(--button-primary-bg);
            color: white;
            margin-right: 12px;
        }
        #manage-content-modal .btn-primary:hover {
            background-color: var(--button-primary-hover-bg);
        }
        #manage-content-modal .btn-secondary {
            background-color: var(--button-secondary-bg);
            color: var(--button-secondary-text);
        }
        #manage-content-modal .btn-secondary:hover {
            background-color: var(--button-secondary-hover-bg);
        }

    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- Overall Container -->
    <div class="flex flex-1 overflow-hidden flex-container">

        <!-- Sidebar -->
        <aside class="sidebar h-full p-4 flex flex-col items-start">
            <div class="mb-6 w-full">
                <!-- New Button (Pinterest style) -->
                <button id="new-button" class="new-button flex items-center px-6 py-3 rounded-full text-base font-medium transition-all duration-200 ease-in-out hover:shadow-lg">
                    <i data-lucide="plus" class="w-5 h-5 mr-3"></i> New
                </button>
            </div>

            <nav class="sidebar-nav w-full">
                <a href="#" data-section="my-drive" class="sidebar-item flex items-center px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-100 active">
                    <i data-lucide="hard-drive" class="w-5 h-5 mr-3"></i>
                    My Drive
                </a>
                <a href="#" data-section="shared-with-me" class="sidebar-item flex items-center px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-100">
                    <i data-lucide="users" class="w-5 h-5 mr-3"></i>
                    Shared with me
                </a>
                <a href="#" data-section="starred" class="sidebar-item flex items-center px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-100">
                    <i data-lucide="star" class="w-5 h-5 mr-3"></i>
                    Starred
                </a>
                <a href="#" data-section="recent" class="sidebar-item flex items-center px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-100">
                    <i data-lucide="clock" class="w-5 h-5 mr-3"></i>
                    Recent
                </a>
                <!-- Moved View Toggle Button to Sidebar -->
                <a href="#" id="view-toggle-sidebar" class="sidebar-item flex items-center px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-100">
                    <i data-lucide="layout-grid" class="w-5 h-5 mr-3"></i>
                    <span id="view-mode-text">Grid View</span>
                </a>
                <!-- Settings Button in Sidebar (Theme toggle moved inside settings modal) -->
                <a href="#" data-section="settings" class="sidebar-item flex items-center px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-100">
                    <i data-lucide="cog" class="w-5 h-5 mr-3"></i>
                    Settings
                </a>
            </nav>

            <div class="mt-auto pt-6 border-t border-gray-200 w-full">
                <!-- Removed the storage section completely -->
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 flex flex-col main-content-scroll">
            <!-- Header for Main Content -->
            <header class="header p-4 flex items-center justify-between">
                <div class="flex items-center w-full max-w-lg search-bar">
                    <button class="p-2 rounded-full hover:bg-gray-100 mr-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                        <i data-lucide="menu" class="w-6 h-6"></i>
                    </button>
                    <!-- Updated logo source -->
                    <img src="https://i.pinimg.com/736x/10/23/45/102345f690875aeb208a390d746a5e9d.jpg" alt="Synapse Logo" class="h-8 w-8 mr-2 rounded-full">
                    <span class="text-xl font-medium hidden sm:block">Synapse</span>
                    <div class="relative flex-1 ml-4">
                        <input type="text" id="search-input" placeholder="Search in Synapse" class="w-full py-2 pl-12 pr-4 rounded-full border focus:outline-none">
                        <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5"></i>
                    </div>
                </div>

                <div class="flex items-center space-x-4">
                    <button class="p-2 rounded-full hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                        <i data-lucide="help-circle" class="w-6 h-6"></i>
                    </button>
                    <button class="p-2 rounded-full hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                        <i data-lucide="apps" class="w-6 h-6"></i>
                    </button>
                    <img src="https://placehold.co/40x40/FF5733/FFFFFF?text=A" alt="User Avatar" class="w-10 h-10 rounded-full cursor-pointer border-2 border-transparent hover:border-blue-500">
                </div>
            </header>

            <!-- Main Content Display -->
            <div id="main-content-display" class="p-6 flex-1 overflow-y-auto">
                <h2 id="current-section-title" class="text-xl font-medium mb-6">My Drive <span id="debug-current-section" class="text-xs text-red-500 ml-2"></span></h2>
                <p id="user-id-display" class="text-sm text-gray-500 mb-4">User ID: Local Session</p>

                <!-- Breadcrumbs for folder navigation -->
                <div id="breadcrumbs" class="mb-4 text-sm flex items-center hidden">
                    <!-- Breadcrumb items will be populated by JS -->
                </div>

                <!-- Content will be dynamically loaded here -->
                <div id="folders-container" class="mb-8">
                    <h3 class="text-sm font-semibold uppercase mb-4">Folders</h3>
                    <div class="file-grid" id="folder-grid">
                        <!-- Folders will be rendered here by JS -->
                    </div>
                </div>

                <div id="files-container">
                    <h3 class="text-sm font-semibold uppercase mb-4">Files</h3>
                    <div class="file-grid" id="file-grid">
                        <!-- Files will be rendered here by JS -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Message Box -->
    <div id="message-box" class="message-box"></div>

    <!-- Settings Modal (New Panel) -->
    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="close-settings-modal" class="modal-close">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            <h3 class="text-lg font-semibold mb-4">Settings</h3>
            <div class="flex flex-col gap-4">
                <button id="open-manage-content-modal-btn" class="btn-primary flex items-center justify-center px-4 py-2 rounded-lg text-sm font-medium">
                    <i data-lucide="folder-cog" class="w-5 h-5 mr-2"></i> Manage Content
                </button>
                <button id="theme-toggle-settings-btn" class="btn-primary flex items-center justify-center px-4 py-2 rounded-lg text-sm font-medium">
                    <i data-lucide="sun-moon" class="w-5 h-5 mr-2"></i> Toggle Theme
                </button>
                <button id="open-account-security-modal-btn" class="btn-primary flex items-center justify-center px-4 py-2 rounded-lg text-sm font-medium">
                    <i data-lucide="user-cog" class="w-5 h-5 mr-2"></i> Account & Security
                </button>
                <p class="text-sm text-gray-500 mt-4 text-center">More settings options coming soon!</p>
            </div>
        </div>
    </div>

    <!-- Account & Security Modal -->
    <div id="account-security-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="close-account-security-modal" class="modal-close">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            <h3 class="text-lg font-semibold mb-4">Account & Security</h3>
            <div class="flex flex-col gap-4">
                <button id="google-sign-in-btn" class="btn-primary flex items-center justify-center px-4 py-2 rounded-lg text-sm font-medium w-full bg-blue-600 hover:bg-blue-700">
                    <i data-lucide="power" class="w-5 h-5 mr-2"></i> Sign in with Google
                </button>
                <button class="btn-secondary flex items-center justify-center px-4 py-2 rounded-lg text-sm font-medium w-full">
                    <i data-lucide="key-round" class="w-5 h-5 mr-2"></i> Change Password
                </button>
                <button class="btn-secondary flex items-center justify-center px-4 py-2 rounded-lg text-sm font-medium w-full">
                    <i data-lucide="shield-check" class="w-5 h-5 mr-2"></i> Two-Factor Authentication
                </button>
                <button class="btn-secondary flex items-center justify-center px-4 py-2 rounded-lg text-sm font-medium w-full">
                    <i data-lucide="laptop" class="w-5 h-5 mr-2"></i> Manage Devices
                </button>
                <p class="text-sm text-gray-500 mt-4 text-center">Security features simulated.</p>
            </div>
        </div>
    </div>

    <!-- Manage Content Modal (Contains old admin panel features) -->
    <div id="manage-content-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="close-manage-content-modal" class="modal-close">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            <h3 class="text-lg font-semibold mb-4">Manage Content</h3>

            <!-- Option to create a file by typing name -->
            <div class="mb-4">
                <p class="text-sm font-medium mb-2">Create new file/folder (Type name):</p>
                <input type="text" id="item-name-input" placeholder="Enter item name (e.g., New Document.docx)">
                <p class="text-sm text-gray-500 mb-2">Optional: Add a link for dummy file to open:</p>
                <input type="text" id="item-link-input" placeholder="Enter URL (e.g., https://example.com)" class="mb-4">
                <div class="flex justify-end mt-2">
                    <button id="create-dummy-file-btn" class="btn-secondary flex items-center px-4 py-2 mr-2">
                        <i data-lucide="file-plus" class="w-4 h-4 mr-2"></i> Create Dummy File
                    </button>
                    <button id="create-folder-btn" class="btn-primary flex items-center px-4 py-2">
                        <i data-lucide="folder-plus" class="w-4 h-4 mr-2"></i> Create Folder
                    </button>
                </div>
            </div>

            <hr class="my-4 border-gray-200">

            <!-- Option to upload a file from computer -->
            <div>
                <p class="text-sm font-medium mb-2">Upload file from computer:</p>
                <input type="file" id="file-upload-input" class="hidden">
                <div class="flex items-center mb-4">
                    <button id="select-file-btn" class="btn-secondary flex items-center px-4 py-2 mr-2">
                        <i data-lucide="upload" class="w-4 h-4 mr-2"></i> Select File to Upload
                    </button>
                    <span id="selected-file-name" class="text-sm truncate">No file selected</span>
                </div>
                <div class="flex justify-end">
                    <button id="upload-file-btn" class="btn-primary flex items-center px-4 py-2" disabled>
                        <i data-lucide="cloud-upload" class="w-4 h-4 mr-2"></i> Upload Selected File
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Content Viewer Modal -->
    <div id="content-viewer" class="modal-overlay">
        <div class="modal-content">
            <div class="content-viewer-header">
                <h3 id="content-viewer-title">
                    <i id="content-viewer-icon" class="w-6 h-6 mr-2"></i>
                    <span></span>
                </h3>
                <button id="close-content-viewer" class="modal-close">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="flex justify-end gap-2 mb-4">
                <button id="summarize-content-btn" class="hidden px-4 py-2 rounded-lg text-sm font-medium border text-blue-700 border-blue-700 hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                    <i data-lucide="sparkles" class="w-4 h-4 inline-block mr-1"></i> Summarize Content
                </button>
                <button id="generate-more-content-btn" class="hidden px-4 py-2 rounded-lg text-sm font-medium border text-purple-700 border-purple-700 hover:bg-purple-50 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50">
                    <i data-lucide="zap" class="w-4 h-4 inline-block mr-1"></i> Generate More Content
                </button>
                <button id="show-original-content-btn" class="hidden px-4 py-2 rounded-lg text-sm font-medium border text-gray-700 border-gray-400 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50">
                    Show Original
                </button>
            </div>
            <div id="content-viewer-body" class="content-viewer-body">
                <!-- Content will be loaded here -->
            </div>
            <div id="content-viewer-loading" class="hidden text-center mt-4">
                <i data-lucide="loader-circle" class="w-6 h-6 animate-spin inline-block mr-2"></i> Loading...
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="modal-overlay show">
        <div class="loading-content">
            Loading your Synapse...
        </div>
    </div>

    <script type="module">
        // Helper to generate unique IDs for local data
        function generateUniqueId() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Firebase SDK Imports and Initialization
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDocs, onSnapshot, addDoc, updateDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Declare global variables for Firebase services
        // These are made 'window.propertyName' so they are accessible throughout your other scripts
        window.app;
        window.db;
        window.auth;
        window.userId;
        window.allFolders = []; // Will be populated by Firestore listeners
        window.allFiles = [];   // Will be populated by Firestore listeners
        window.starredFiles = []; // To store starred files for the 'Starred' section
        window.recentFilesFolders = []; // To store recent files/folders for the 'Recent' section

        // Global variables provided by the Canvas environment.
        // They are crucial for initializing Firebase within this specific platform.
        // Ensure they are correctly accessed with fallback for local development.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        document.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons(); // Initialize Lucide Icons immediately
            console.log("DOM Content Loaded. Initializing Firebase...");

            // Immediately hide and remove the loading overlay when the DOM is ready.
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.classList.remove('show');
                loadingOverlay.style.display = 'none';
                // Remove the element from the DOM after a short delay to ensure rendering completes
                setTimeout(() => {
                    loadingOverlay.remove();
                    console.log("Loading overlay removed from DOM.");
                }, 100);
            }

            try {
                // Initialize Firebase App
                window.app = initializeApp(firebaseConfig);
                // Get Firestore and Auth instances
                window.db = getFirestore(window.app);
                window.auth = getAuth(window.app);

                console.log("Firebase App Initialized.");

                // Authenticate user initially with custom token or anonymously
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(window.auth, __initial_auth_token);
                    console.log("Signed in with custom token.");
                } else {
                    await signInAnonymously(window.auth);
                    console.log("Signed in anonymously.");
                }

                // Use a promise to ensure auth state is settled before proceeding
                const userAuthPromise = new Promise(resolve => {
                    const unsubscribe = onAuthStateChanged(window.auth, (user) => {
                        if (user) {
                            window.userId = user.uid;
                            document.getElementById('user-id-display').textContent = `User ID: ${window.userId}`;
                            console.log("Firebase Auth State Changed. User ID:", window.userId);
                        } else {
                            window.userId = crypto.randomUUID();
                            document.getElementById('user-id-display').textContent = `User ID: Anonymous (local ID: ${window.userId.substring(0, 8)}...)`;
                            console.log("Firebase Auth State Changed. No user, using anonymous ID:", window.userId);
                        }
                        unsubscribe(); // Unsubscribe after the first state change
                        resolve();
                    });
                });

                await userAuthPromise; // Wait for auth state to be confirmed
                console.log("Authentication state settled. Proceeding with app initialization.");

                try {
                    // Call your app's main initialization function after auth is ready
                    await initializeSynapseApp(); // Now awaiting initializeSynapseApp
                    console.log("Synapse app initialized successfully.");
                } catch (initError) {
                    console.error("Error during Synapse app initialization:", initError);
                    showMessage("App failed to load. Please try refreshing or check console for errors.", 5000);
                }

            } catch (error) {
                console.error("Critical Error initializing Firebase or signing in:", error);
                showMessage("Failed to initialize app. Please check console for details.", 8000);
                // Fallback to purely local data if Firebase initialization fails
                window.userId = crypto.randomUUID();
                document.getElementById('user-id-display').textContent = `User ID: Anonymous (Firebase Error, local ID: ${window.userId.substring(0, 8)}...)`;
                // Attempt to run app with local data, but it might not work well without Firestore.
            }
        });

        // --- Your Main Synapse App Logic Goes Here ---
        // This function will be called AFTER Firebase is initialized and the user is authenticated.
        async function initializeSynapseApp() { // Made async
            console.log("initializeSynapseApp started.");
            const sidebarItems = document.querySelectorAll('.sidebar-item');
            const searchInput = document.getElementById('search-input');
            const currentSectionTitle = document.getElementById('current-section-title');
            const folderGrid = document.getElementById('folder-grid');
            const fileGrid = document.getElementById('file-grid');
            const messageBox = document.getElementById('message-box');
            const userIdDisplay = document.getElementById('user-id-display');
            const breadcrumbsContainer = document.getElementById('breadcrumbs');

            const newButton = document.getElementById('new-button');
            const viewToggleSidebarBtn = document.getElementById('view-toggle-sidebar');
            const viewModeText = document.getElementById('view-mode-text');
            const debugCurrentSectionSpan = document.getElementById('debug-current-section');

            // Settings Modal Elements
            const settingsModal = document.getElementById('settings-modal');
            const closeSettingsModalBtn = document = document.getElementById('close-settings-modal');
            const openManageContentModalBtn = document.getElementById('open-manage-content-modal-btn');
            const themeToggleSettingsBtn = document.getElementById('theme-toggle-settings-btn');
            const openAccountSecurityModalBtn = document.getElementById('open-account-security-modal-btn');

            // Account & Security Modal Elements
            const accountSecurityModal = document.getElementById('account-security-modal');
            const closeAccountSecurityModalBtn = document.getElementById('close-account-security-modal');
            const googleSignInBtn = document.getElementById('google-sign-in-btn'); // New: Google Sign-in button

            // Manage Content Modal Elements
            const manageContentModal = document.getElementById('manage-content-modal');
            const closeManageContentModalBtn = document.getElementById('close-manage-content-modal');
            const itemNameInput = document.getElementById('item-name-input');
            const itemLinkInput = document.getElementById('item-link-input');
            const createDummyFileBtn = document.getElementById('create-dummy-file-btn');
            const createFolderBtn = document.getElementById('create-folder-btn');
            const fileUploadInput = document.getElementById('file-upload-input');
            const selectFileBtn = document.getElementById('select-file-btn');
            let selectedFile = null;
            const selectedFileNameSpan = document.getElementById('selected-file-name');
            const uploadFileBtn = document.getElementById('upload-file-btn'); // Corrected from document()

            // Content Viewer Elements
            const contentViewer = document.getElementById('content-viewer');
            const closeContentViewerBtn = document.getElementById('close-content-viewer');
            const contentViewerTitleSpan = document.querySelector('#content-viewer-title span');
            const contentViewerIcon = document.getElementById('content-viewer-icon');
            const contentViewerBody = document.getElementById('content-viewer-body');
            const summarizeContentBtn = document.getElementById('summarize-content-btn');
            const generateMoreContentBtn = document.getElementById('generate-more-content-btn');
            const showOriginalContentBtn = document.getElementById('show-original-content-btn');
            const contentViewerLoading = document.getElementById('content-viewer-loading');

            // Folder navigation state
            let currentParentFolderId = null;
            let currentPath = [{ name: 'My Drive', id: null }];

            let isListView = false;

            // New global variables for content viewer state
            let currentViewerItem = null;
            let originalContent = '';

            let typedSequence = '';
            const adminPanelTrigger = 'barneyadminpanel';
            let sequenceTimeout;
            let currentSection = 'my-drive';


            // --- Utility Functions ---

            // Show a transient message
            function showMessage(message, duration = 3000) {
                messageBox.textContent = message;
                messageBox.classList.add('show');
                setTimeout(() => {
                    messageBox.classList.remove('show');
                }, duration);
            }

            // Get icon and color based on file extension
            function getFileIconAndColor(fileName) {
                let icon = 'file';
                let color = 'text-gray-500';
                const extMatch = fileName.match(/\.([0-9a-z]+)(?:[\?#]|$)/i);
                if (extMatch) {
                    const ext = extMatch[1].toLowerCase();
                    switch(ext) {
                        case 'docx': icon = 'file-text'; color = 'text-blue-600'; break;
                        case 'xlsx': icon = 'sheet'; color = 'text-green-600'; break;
                        case 'pptx': icon = 'presentation'; color = 'text-orange-600'; break;
                        case 'pdf': icon = 'file-text'; color = 'text-red-600'; break;
                        case 'jpg':
                        case 'jpeg':
                        case 'png':
                        case 'gif': icon = 'image'; color = 'text-purple-600'; break;
                        case 'js':
                        case 'html':
                        case 'css': icon = 'code'; color = 'text-gray-700'; break;
                        case 'txt': icon = 'file-text'; color = 'text-gray-500'; break;
                        case 'zip':
                        case 'rar': icon = 'archive'; color = 'text-yellow-600'; break;
                        case 'mp3':
                        case 'wav': icon = 'music'; color = 'text-pink-600'; break;
                        case 'mp4':
                        case 'avi': icon = 'video'; color = 'text-teal-600'; break;
                        default: break;
                    }
                }
                return { icon, color };
            }

            // Update debug display with currentSection
            function updateDebugSectionDisplay() {
                debugCurrentSectionSpan.textContent = `(DEBUG: ${currentSection})`;
            }

            // --- Manage Content Panel Functions ---
            function showManageContentModal() {
                manageContentModal.classList.add('show');
                itemNameInput.focus();
                lucide.createIcons();
                selectedFile = null;
                fileUploadInput.value = '';
                selectedFileNameSpan.textContent = 'No file selected';
                uploadFileBtn.disabled = true;
            }

            function hideManageContentModal() {
                manageContentModal.classList.remove('show');
                itemNameInput.value = '';
                itemLinkInput.value = '';
                selectedFile = null;
                fileUploadInput.value = '';
                selectedFileNameSpan.textContent = 'No file selected';
                uploadFileBtn.disabled = true;
            }

            // --- Settings Modal Functions ---
            function showSettingsModal() {
                settingsModal.classList.add('show');
                lucide.createIcons();
            }

            function hideSettingsModal() {
                settingsModal.classList.remove('show');
            }

            // --- Account & Security Modal Functions ---
            function showAccountSecurityModal() {
                accountSecurityModal.classList.add('show');
                lucide.createIcons();
            }

            function hideAccountSecurityModal() {
                accountSecurityModal.classList.remove('show');
            }


            // --- Content Viewer Functions ---
            function openContentViewer(item) {
                if (item.type === 'redirect-file' && item.redirectUrl) {
                    console.log("Attempting to redirect to:", item.redirectUrl);
                    window.open(item.redirectUrl, '_blank');
                    showMessage(`Redirecting to ${item.name}!`);
                    return;
                }

                currentViewerItem = item;
                originalContent = item.content || `This is content for ${item.name}.`;

                contentViewerTitleSpan.textContent = item.name;
                contentViewerIcon.setAttribute('data-lucide', item.icon);
                contentViewerIcon.className = `w-6 h-6 mr-2 ${item.color || 'text-gray-500'}`;

                displayContentInViewer(originalContent);
                showOriginalContentBtn.classList.add('hidden');

                if (item.type === 'file' || item.type === 'redirect-file') {
                    summarizeContentBtn.classList.remove('hidden');
                    generateMoreContentBtn.classList.remove('hidden');
                } else {
                    summarizeContentBtn.classList.add('hidden');
                    generateMoreContentBtn.classList.add('hidden');
                }

                contentViewer.classList.add('show');
                lucide.createIcons();
            }

            function displayContentInViewer(content) {
                contentViewerBody.innerHTML = `<p class="whitespace-pre-wrap">${content}</p>`;
            }

            function closeContentViewer() {
                contentViewer.classList.remove('show');
                currentViewerItem = null;
                originalContent = '';
                summarizeContentBtn.classList.add('hidden');
                generateMoreContentBtn.classList.add('hidden');
                showOriginalContentBtn.classList.add('hidden');
            }

            // Function to make Gemini API call with exponential backoff
            async function callGeminiApi(prompt, retries = 3, delay = 1000) {
                contentViewerLoading.classList.remove('hidden');
                for (let i = 0; i < retries; i++) {
                    try {
                        let chatHistory = [];
                        chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                        const payload = { contents: chatHistory };
                        const apiKey = "";
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const result = await response.json();

                        if (result.candidates && result.candidates.length > 0 &&
                            result.candidates[0].content && result.candidates[0].content.parts &&
                            result.candidates[0].content.parts.length > 0) {
                            return result.candidates[0].content.parts[0].text;
                        } else {
                            throw new Error('Gemini API response structure unexpected or content missing.');
                        }
                    } catch (error) {
                        console.error(`Attempt ${i + 1} failed:`, error);
                        if (i < retries - 1) {
                            await new Promise(res => setTimeout(res, delay));
                            delay *= 2;
                        } else {
                            throw error;
                        }
                    }
                }
            }

            // Event listener for Summarize button
            summarizeContentBtn.addEventListener('click', async () => {
                if (!currentViewerItem || !currentViewerItem.content) {
                    showMessage("No content to summarize.", 3000);
                    return;
                }

                showOriginalContentBtn.classList.remove('hidden');
                summarizeContentBtn.classList.add('hidden');
                generateMoreContentBtn.classList.add('hidden');

                try {
                    const summary = await callGeminiApi(`Summarize the following content concisely: ${currentViewerItem.content}`);
                    displayContentInViewer(summary);
                    showMessage("Content summarized by Gemini! âœ¨", 3000);
                }
                catch (error) {
                    console.error("Error summarizing content:", error);
                    displayContentInViewer("Failed to summarize content. Please try again later.");
                    showMessage("Error summarizing content. ðŸ˜ž", 5000);
                } finally {
                    contentViewerLoading.classList.add('hidden');
                }
            });

            // Event listener for Generate More Content button
            generateMoreContentBtn.addEventListener('click', async () => {
                if (!currentViewerItem || !currentViewerItem.content) {
                    showMessage("No original content to build upon.", 3000);
                    return;
                }

                showOriginalContentBtn.classList.remove('hidden');
                summarizeContentBtn.classList.add('hidden');
                generateMoreContentBtn.classList.add('hidden');

                try {
                    const newContent = await callGeminiApi(`Expand on the following content, adding more detail and depth: "${currentViewerItem.content}"`);
                    displayContentInViewer(newContent);
                    showMessage("More content generated by Gemini! âœ¨", 3000);
                } catch (error) {
                    console.error("Error generating more content:", error);
                    displayContentInViewer("Failed to generate more content. Please try again later.");
                    showMessage("Error generating more content. ðŸ˜ž", 5000);
                } finally {
                    contentViewerLoading.classList.add('hidden');
                }
            });

            // Event listener for Show Original Content button
            showOriginalContentBtn.addEventListener('click', () => {
                if (currentViewerItem) {
                    displayContentInViewer(originalContent);
                    showOriginalContentBtn.classList.add('hidden');
                    summarizeContentBtn.classList.remove('hidden');
                    generateMoreContentBtn.classList.remove('hidden');
                }
            });


            // Function to toggle starred status in Firestore
            async function toggleStarredStatus(fileId, currentStarredStatus) {
                if (!window.db || !window.userId) {
                    showMessage("App not ready, cannot update star status.");
                    return;
                }
                try {
                    const fileDocRef = doc(window.db, `artifacts/${appId}/users/${window.userId}/files`, fileId);
                    await updateDoc(fileDocRef, {
                        isStarred: !currentStarredStatus,
                        modified: new Date().toISOString() // Update modified timestamp as ISO string
                    });
                    showMessage(`File ${!currentStarredStatus ? 'starred' : 'unstarred'} in Firestore!`);
                    // The onSnapshot listener will automatically re-render the content.
                } catch (e) {
                    console.error("Error updating document: ", e);
                    showMessage("Failed to update starred status in Firestore. ðŸ˜ž");
                }
            }


            // --- Render Content for Current Folder in My Drive ---
            function renderMyDriveContent() {
                console.log("renderMyDriveContent called. currentParentFolderId:", currentParentFolderId);
                currentSectionTitle.textContent = currentPath[currentPath.length - 1].name;
                updateDebugSectionDisplay();
                updateBreadcrumbs();
                breadcrumbsContainer.classList.remove('hidden');

                // Filter based on `window.allFolders` and `window.allFiles`
                const foldersToRender = window.allFolders.filter(f => f.parentId === currentParentFolderId);
                const filesToRender = window.allFiles.filter(f => f.parentId === currentParentFolderId);

                folderGrid.classList.toggle('file-list', isListView);
                folderGrid.classList.toggle('file-grid', !isListView);
                fileGrid.classList.toggle('file-list', isListView);
                fileGrid.classList.toggle('file-grid', !isListView);


                folderGrid.innerHTML = '';
                fileGrid.innerHTML = '';

                if (foldersToRender.length === 0 && filesToRender.length === 0) {
                    fileGrid.innerHTML = '<p class="text-gray-500">No items found in this folder.</p>';
                    document.getElementById('folders-container').style.display = 'block';
                    document.getElementById('files-container').style.display = 'block';
                } else {
                    if (foldersToRender.length > 0) {
                        document.getElementById('folders-container').style.display = 'block';
                        foldersToRender.forEach(folder => {
                            const modifiedDate = folder.modified ? new Date(folder.modified).toLocaleString() : 'N/A';
                            const folderDiv = document.createElement('div');
                            folderDiv.className = `folder-item ${isListView ? 'list-view-item' : ''}`;
                            folderDiv.innerHTML = `
                                <i data-lucide="${folder.icon}" class="w-6 h-6 text-blue-500 ${isListView ? '' : 'mb-2'}"></i>
                                <span class="text-sm font-medium file-name">${folder.name}</span>
                                <span class="text-xs ${isListView ? 'modified-date' : 'mt-1'}">${modifiedDate}</span>
                            `;
                            folderDiv.onclick = () => {
                                console.log("Folder clicked:", folder.name);
                                currentParentFolderId = folder.id;
                                currentPath.push({ name: folder.name, id: folder.id });
                                renderMyDriveContent();
                            };
                            folderGrid.appendChild(folderDiv);
                        });
                    } else {
                        document.getElementById('folders-container').style.display = 'none';
                    }

                    if (filesToRender.length > 0) {
                        document.getElementById('files-container').style.display = 'block';
                        filesToRender.forEach(file => {
                            const modifiedDate = file.modified ? new Date(file.modified).toLocaleString() : 'N/A';
                            const fileDiv = document.createElement('div');
                            fileDiv.className = `file-item ${isListView ? 'list-view-item' : ''}`;
                            fileDiv.innerHTML = `
                                <i data-lucide="${file.icon}" class="w-6 h-6 ${file.color || 'text-gray-500'} ${isListView ? '' : 'mb-2'}"></i>
                                <span class="text-sm font-medium file-name">${file.name}</span>
                                <span class="text-xs ${isListView ? 'modified-date' : 'mt-1'}">${modifiedDate}</span>
                                <i data-lucide="star" class="star-icon w-5 h-5 ${file.isStarred ? 'text-yellow-400' : 'text-gray-400'}"></i>
                            `;
                            const starIcon = fileDiv.querySelector('.star-icon');
                            starIcon.addEventListener('click', (e) => {
                                e.stopPropagation();
                                toggleStarredStatus(file.id, file.isStarred);
                            });

                            fileDiv.addEventListener('click', (e) => {
                                if (!e.target.closest('.star-icon')) {
                                    console.log("File clicked:", file.name);
                                    openContentViewer(file);
                                }
                            });
                            fileGrid.appendChild(fileDiv);
                        });
                    } else {
                        document.getElementById('files-container').style.display = 'none';
                    }
                }
                lucide.createIcons();
            }

            // Function to update breadcrumbs
            function updateBreadcrumbs() {
                breadcrumbsContainer.innerHTML = '';

                currentPath.forEach((pathItem, index) => {
                    const span = document.createElement('span');
                    if (index > 0) {
                        const separator = document.createElement('span');
                        separator.className = 'mx-2';
                        separator.textContent = '>';
                        breadcrumbsContainer.appendChild(separator);
                    }
                    const link = document.createElement('a');
                    link.href = '#';
                    link.className = 'hover:underline';
                    if (index === currentPath.length - 1) {
                        link.className += ' cursor-default no-underline';
                        link.onclick = (e) => e.preventDefault();
                    } else {
                        link.className += ' text-blue-600';
                        link.onclick = (e) => {
                            e.preventDefault();
                            currentPath.splice(index + 1);
                            currentParentFolderId = pathItem.id;
                            renderMyDriveContent();
                        };
                    }
                    link.textContent = pathItem.name;
                    breadcrumbsContainer.appendChild(link);
                });
            }

            // --- Handles sidebar navigation (My Drive, Shared, Starred, Recent, Settings) ---
            function handleSidebarNavigation(section) {
                console.log("handleSidebarNavigation called with section:", section);
                currentSection = section;
                updateDebugSectionDisplay();
                searchInput.value = '';

                hideSettingsModal();
                hideManageContentModal();
                hideAccountSecurityModal();
                closeContentViewer();

                if (section === 'settings') {
                    showSettingsModal();
                    folderGrid.innerHTML = '';
                    fileGrid.innerHTML = '<p class="text-gray-500">Open the Settings panel to manage your Synapse preferences.</p>';
                    document.getElementById('folders-container').style.display = 'none';
                    document.getElementById('files-container').style.display = 'block';
                    currentSectionTitle.textContent = 'Settings';
                    breadcrumbsContainer.classList.add('hidden');
                    return;
                }

                if (section === 'my-drive') {
                    currentParentFolderId = null;
                    currentPath = [{ name: 'My Drive', id: null }];
                    renderMyDriveContent();
                    return;
                }

                breadcrumbsContainer.classList.add('hidden');
                let foldersToShow = [];
                let filesToShow = [];
                let title = '';

                switch (section) {
                    case 'shared-with-me':
                        title = 'Shared with me';
                        filesToShow = window.allFiles.filter(f => f.name.includes('Report') || f.name.includes('Budget')).slice(0, 3);
                        foldersToShow = [];
                        break;
                    case 'starred':
                        title = 'Starred';
                        filesToShow = window.starredFiles;
                        foldersToShow = [];
                        break;
                    case 'recent':
                        title = 'Recent';
                        filesToShow = window.recentFilesFolders.filter(item => item.type === 'file');
                        foldersToShow = window.recentFilesFolders.filter(item => item.type === 'folder');
                        break;
                    default:
                        console.warn("handleSidebarNavigation: Unknown section encountered, defaulting title. Section received:", section);
                        title = 'Unknown Section';
                        break;
                }

                console.log("handleSidebarNavigation: Setting currentSectionTitle to:", title);
                currentSectionTitle.textContent = title;
                console.log("handleSidebarNavigation: currentSectionTitle after assignment:", currentSectionTitle.textContent);

                renderFlatContent(foldersToShow, filesToShow);
            }

            // A helper function to render content for flat sections (non-My Drive)
            function renderFlatContent(foldersToRender, filesToRender) {
                folderGrid.classList.toggle('file-list', isListView);
                folderGrid.classList.toggle('file-grid', !isListView);
                fileGrid.classList.toggle('file-list', isListView);
                fileGrid.classList.toggle('file-grid', !isListView);

                folderGrid.innerHTML = '';
                fileGrid.innerHTML = '';

                if (foldersToRender.length === 0 && filesToRender.length === 0) {
                    fileGrid.innerHTML = '<p class="text-gray-500">No items found in this section.</p>';
                    document.getElementById('folders-container').style.display = 'block';
                    document.getElementById('files-container').style.display = 'block';
                } else {
                    if (foldersToRender.length > 0) {
                        document.getElementById('folders-container').style.display = 'block';
                        foldersToRender.forEach(folder => {
                            const modifiedDate = folder.modified ? new Date(folder.modified).toLocaleString() : 'N/A';
                            const folderDiv = document.createElement('div');
                            folderDiv.className = `folder-item ${isListView ? 'list-view-item' : ''}`;
                            folderDiv.innerHTML = `
                                <i data-lucide="${folder.icon}" class="w-6 h-6 text-blue-500 ${isListView ? '' : 'mb-2'}"></i>
                                <span class="text-sm font-medium file-name">${folder.name}</span>
                                <span class="text-xs ${isListView ? 'modified-date' : 'mt-1'}">${modifiedDate}</span>
                            `;
                            folderDiv.onclick = () => {
                                console.log("Folder clicked (flat view):", folder.name);
                                showMessage(`Folder clicked (in ${currentSection}): ${folder.name}`);
                            };
                            folderGrid.appendChild(folderDiv);
                        });
                    } else {
                        document.getElementById('folders-container').style.display = 'none';
                    }

                    if (filesToRender.length > 0) {
                        document.getElementById('files-container').style.display = 'block';
                        filesToRender.forEach(file => {
                            const modifiedDate = file.modified ? new Date(file.modified).toLocaleString() : 'N/A';
                            const fileDiv = document.createElement('div');
                            fileDiv.className = `file-item ${isListView ? 'list-view-item' : ''}`;
                            fileDiv.innerHTML = `
                                <i data-lucide="${file.icon}" class="w-6 h-6 ${file.color || 'text-gray-500'} ${isListView ? '' : 'mb-2'}"></i>
                                <span class="text-sm font-medium file-name">${file.name}</span>
                                <span class="text-xs ${isListView ? 'modified-date' : 'mt-1'}">${modifiedDate}</span>
                                <i data-lucide="star" class="star-icon w-5 h-5 ${file.isStarred ? 'text-yellow-400' : 'text-gray-400'}"></i>
                            `;
                            const starIcon = fileDiv.querySelector('.star-icon');
                            starIcon.addEventListener('click', (e) => {
                                e.stopPropagation();
                                toggleStarredStatus(file.id, file.isStarred);
                            });

                            fileDiv.onclick = (e) => {
                                if (!e.target.closest('.star-icon')) {
                                    console.log("File clicked (flat view):", file.name);
                                    openContentViewer(file);
                                }
                            };
                            fileGrid.appendChild(fileDiv);
                        });
                    } else {
                        document.getElementById('files-container').style.display = 'none';
                    }
                }
                lucide.createIcons();
            }

            // Function to populate initial data (replaces Firebase data fetching)
            async function ensureEaglercraftContent() {
                console.log("ensureEaglercraftContent started.");
                if (!window.db || !window.userId) {
                    console.warn("Firebase not ready for ensureEaglercraftContent.");
                    return;
                }

                const userFoldersRef = collection(window.db, `artifacts/${appId}/users/${window.userId}/folders`);
                const userFilesRef = collection(window.db, `artifacts/${appId}/users/${window.userId}/files`);

                // Check if eaglercraft folder already exists in Firestore
                const existingFoldersSnapshot = await getDocs(query(userFoldersRef, where("name", "==", "eaglercraft"), where("parentId", "==", null)));
                let eaglercraftFolderId;

                if (existingFoldersSnapshot.empty) {
                    console.log("Creating 'eaglercraft' folder...");
                    const newFolderDoc = await addDoc(userFoldersRef, {
                        name: 'eaglercraft',
                        type: 'folder',
                        icon: 'folder',
                        modified: new Date().toISOString(),
                        parentId: null,
                        ownerId: window.userId
                    });
                    eaglercraftFolderId = newFolderDoc.id;
                    showMessage('Created "eaglercraft" folder in Firestore.');
                    console.log("Created 'eaglercraft' folder with ID:", eaglercraftFolderId);
                } else {
                    eaglercraftFolderId = existingFoldersSnapshot.docs[0].id;
                    console.log("'eaglercraft' folder already exists with ID:", eaglercraftFolderId);
                }

                const eaglercraftFileRedirects = {
                    "BetterEagler USA dev-a1.html": "https://sites.google.com/view/eagler-usadev-a1/home",
                    "eag1_11_2 (1).html": "https://eaglercraft.com/eag1_11_2/",
                    "Eaglercraft_1.12_Offline_Download.zip": "https://www.mediafire.com/file/o6k32g3q3k0p4o0/Eaglercraft_1.12_Offline_Download.zip/file",
                    "EaglercraftX_1.8_u39_Offline_Signed.html": "https://eaglercraft.com/eaglercraftx_1.8_u39_offline_signed.html",
                    "EaglercraftZ_1.16.5_Offline_en_US (1).html": "https://archive.org/details/eaglercraftz-1.16.5-offline",
                    "EaglercraftZ_1.16.5_Offline_en_US.html": "https://eaglercraft.com/eaglercraftz_1.16.5_offline_en_US.html",
                    "EaglerForge v1.3.2.html": "https://www.mediafire.com/file/r562y4n3a7x1z9k/EaglerForge_v1.3.2.zip/file",
                    "EaglerForge v1.html": "https://eaglercraft.com/eaglerforge_v1.html",
                    "EaglyMC u6.html": "https://www.mediafire.com/file/a8k5m7g4h2j1c0p/EaglyMC_u6.zip/file",
                    "Prism Client 1.0.html": "https://www.mediafire.com/file/z9x8y7w6v5u4t3s/Prism_Client_1.0.zip/file",
                    "SigmaClient-1.0.0-u40.html": "https://www.mediafire.com/file/x1c2v3b4n5m6l7k/SigmaClient-1.0.0-u40.zip/file",
                    "Starlike Client 0.4.0.html": "https://www.mediafire.com/file/p0o9i8u7y6t5r4e/Starlike_Client_0.4.0.zip/file"
                };

                const defaultStarredFiles = [
                    "Eaglercraft_1.12_Offline_Download.zip",
                    "EaglercraftX_1.8_u39_Offline_Signed.html"
                ];

                for (const fileName in eaglercraftFileRedirects) {
                    const redirectUrl = eaglercraftFileRedirects[fileName];
                    const existingFilesSnapshot = await getDocs(query(userFilesRef, where("name", "==", fileName), where("parentId", "==", eaglercraftFolderId)));

                    if (existingFilesSnapshot.empty) {
                        const shouldBeStarred = defaultStarredFiles.includes(fileName);
                        const newFile = {
                            name: fileName,
                            type: 'redirect-file',
                            icon: 'link',
                            color: 'text-green-700',
                            modified: new Date().toISOString(),
                            content: `This is dummy content for "${fileName}". It simulates content you might find in a file.`,
                            redirectUrl: redirectUrl,
                            parentId: eaglercraftFolderId,
                            isStarred: shouldBeStarred,
                            ownerId: window.userId
                        };
                        await addDoc(userFilesRef, newFile);
                        showMessage(`Created "${fileName}" file in Firestore.`);
                    } else {
                        const fileDoc = existingFilesSnapshot.docs[0];
                        const currentData = fileDoc.data();
                        let updatedData = {};
                        let changed = false;

                        const shouldBeStarred = defaultStarredFiles.includes(fileName);
                        if (currentData.isStarred !== shouldBeStarred) {
                            updatedData.isStarred = shouldBeStarred;
                            changed = true;
                        }
                        if (currentData.redirectUrl !== redirectUrl) {
                            updatedData.redirectUrl = redirectUrl;
                            changed = true;
                        }
                        if (changed) {
                            updatedData.modified = new Date().toISOString();
                            await updateDoc(fileDoc.ref, updatedData);
                            showMessage(`Updated "${fileName}" details in Firestore.`);
                        }
                    }
                }
                console.log("ensureEaglercraftContent finished.");
            }


            // --- Event Listeners ---

            // Sidebar Navigation
            sidebarItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    sidebarItems.forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    const section = item.getAttribute('data-section');
                    handleSidebarNavigation(section);
                });
            });

            // Search Input Filtering
            searchInput.addEventListener('input', () => {
                const query = searchInput.value.toLowerCase();
                if (currentSection === 'my-drive') {
                    const filteredFolders = window.allFolders.filter(folder =>
                        folder.parentId === currentParentFolderId && folder.name.toLowerCase().includes(query)
                    );
                    const filteredFiles = window.allFiles.filter(file =>
                        file.parentId === currentParentFolderId && file.name.toLowerCase().includes(query)
                    );
                    renderFlatContent(filteredFolders, filteredFiles);
                } else {
                    let itemsToSearch = [];
                    if (currentSection === 'starred') {
                        itemsToSearch = window.starredFiles;
                    } else if (currentSection === 'recent') {
                        itemsToSearch = window.recentFilesFolders;
                    } else if (currentSection === 'shared-with-me') {
                        itemsToSearch = window.allFiles.filter(f => f.name.includes('Report') || f.name.includes('Budget'));
                    }

                    const filteredFolders = itemsToSearch.filter(item =>
                        item.type === 'folder' && item.name.toLowerCase().includes(query)
                    );
                    const filteredFiles = itemsToSearch.filter(item =>
                        item.type === 'file' && item.name.toLowerCase().includes(query)
                    );
                    renderFlatContent(filteredFolders, filteredFiles);
                }
            });


            // View Toggle Button Listener (now in sidebar)
            viewToggleSidebarBtn.addEventListener('click', (e) => {
                e.preventDefault();
                isListView = !isListView;
                if (isListView) {
                    viewToggleSidebarBtn.innerHTML = '<i data-lucide="list" class="w-5 h-5 mr-3"></i><span id="view-mode-text">List View</span>';
                } else {
                    viewToggleSidebarBtn.innerHTML = '<i data-lucide="layout-grid" class="w-5 h-5 mr-3"></i><span id="view-mode-text">Grid View</span>';
                }
                lucide.createIcons();
                if (currentSection === 'my-drive') {
                    renderMyDriveContent();
                } else {
                    handleSidebarNavigation(currentSection);
                }
                updateDebugSectionDisplay();
            });

            // "New" button in sidebar opens settings modal
            newButton.addEventListener('click', showSettingsModal);

            // Theme Toggle Button Listener (now in settings modal)
            themeToggleSettingsBtn.addEventListener('click', (e) => {
                e.preventDefault();
                document.body.classList.toggle('theme-drive');
                lucide.createIcons();
            });

            // Settings Modal Listeners
            closeSettingsModalBtn.addEventListener('click', hideSettingsModal);
            openManageContentModalBtn.addEventListener('click', () => {
                hideSettingsModal();
                showManageContentModal();
            });
            openAccountSecurityModalBtn.addEventListener('click', () => {
                hideSettingsModal();
                showAccountSecurityModal();
            });

            // Account Security Modal Listeners
            closeAccountSecurityModalBtn.addEventListener('click', hideAccountSecurityModal);
            // New: Google Sign-in button listener
            googleSignInBtn.addEventListener('click', async () => {
                try {
                    const provider = new GoogleAuthProvider();
                    await signInWithPopup(window.auth, provider);
                    showMessage("Signed in with Google successfully! ðŸŽ‰", 4000);
                    hideAccountSecurityModal(); // Close modal after successful sign-in
                } catch (error) {
                    console.error("Error signing in with Google:", error);
                    showMessage(`Google Sign-in failed: ${error.message}. ðŸ˜ž`, 5000);
                }
            });


            // Manage Content Modal Listeners
            closeManageContentModalBtn.addEventListener('click', hideManageContentModal);

            // Create Dummy File button
            createDummyFileBtn.addEventListener('click', async () => {
                const name = itemNameInput.value.trim();
                const link = itemLinkInput.value.trim();

                if (!name) {
                    showMessage('Please enter a name for the dummy file.');
                    return;
                }

                if (currentSection !== 'my-drive') {
                    showMessage('Dummy file creation is only supported in "My Drive". Please switch to "My Drive".');
                    return;
                }

                let fileType;
                let fileIcon;
                let fileColor;
                let fileContent;
                let redirectUrl; // Declare outside the if/else for broader scope

                if (link) {
                    let validLink = link;
                    if (!link.startsWith('http://') && !link.startsWith('https://')) {
                        validLink = `https://${link}`;
                    }
                    fileType = 'redirect-file';
                    fileIcon = 'link';
                    fileColor = 'text-green-700';
                    fileContent = `This dummy file redirects to: ${validLink}`;
                    redirectUrl = validLink;
                } else {
                    const { icon, color } = getFileIconAndColor(name);
                    fileType = 'file';
                    fileIcon = icon;
                    fileColor = color;
                    fileContent = `This is dummy content for the file "${name}". No actual file data is stored.`;
                    // redirectUrl remains undefined if no link was provided
                }

                // Now construct the newFile object after all properties are determined
                const newFile = {
                    name: name,
                    type: fileType,
                    icon: fileIcon,
                    color: fileColor,
                    modified: new Date().toISOString(),
                    content: fileContent,
                    redirectUrl: redirectUrl, // This will be undefined if no link was provided
                    parentId: currentParentFolderId,
                    isStarred: false,
                    ownerId: window.userId
                };

                try {
                    await addDoc(collection(window.db, `artifacts/${appId}/users/${window.userId}/files`), newFile);
                    showMessage(`Dummy file "${name}" created successfully in Firestore!`);
                    hideManageContentModal();
                } catch (e) {
                    console.error("Error adding document: ", e);
                    showMessage("Failed to create file in Firestore.ðŸ˜ž");
                }
            });

            // Create Folder button
            createFolderBtn.addEventListener('click', async () => {
                const name = itemNameInput.value.trim();
                if (!name) {
                    showMessage('Please enter a name for the folder.');
                    return;
                }

                if (currentSection !== 'my-drive') {
                    showMessage('Folder creation is only supported in "My Drive". Please switch to "My Drive".');
                    return;
                }

                const newFolder = {
                    name: name,
                    type: 'folder',
                    icon: 'folder',
                    modified: new Date().toISOString(),
                    parentId: currentParentFolderId,
                    ownerId: window.userId
                };

                try {
                    await addDoc(collection(window.db, `artifacts/${appId}/users/${window.userId}/folders`), newFolder);
                    showMessage(`Folder "${name}" created successfully in Firestore!`);
                    hideManageContentModal();
                } catch (e) {
                    console.error("Error adding document: ", e);
                    showMessage("Failed to create folder in Firestore.ðŸ˜ž");
                }
            });

            // Trigger file input click when "Select File" button is clicked
            selectFileBtn.addEventListener('click', () => {
                fileUploadInput.click();
            });

            // Handle file selection
            fileUploadInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    selectedFile = e.target.files[0];
                    selectedFileNameSpan.textContent = selectedFile.name;
                    uploadFileBtn.disabled = false;
                } else {
                    selectedFile = null;
                    selectedFileNameSpan.textContent = 'No file selected';
                    uploadFileBtn.disabled = true;
                }
            });

            // Handle actual file upload (simulated)
            uploadFileBtn.addEventListener('click', async () => {
                if (!selectedFile) {
                    showMessage('Please select a file to upload.');
                    return;
                }

                if (currentSection !== 'my-drive') {
                    showMessage('File upload is only supported in "My Drive". Please switch to "My Drive".');
                    return;
                }

                const { icon, color } = getFileIconAndColor(selectedFile.name);

                const uploadedFileRecord = {
                    name: selectedFile.name,
                    type: 'file',
                    icon: icon,
                    color: color,
                    modified: new Date().toISOString(),
                    size: selectedFile.size,
                    content: `This is a simulated content for the uploaded file "${selectedFile.name}". It has a size of ${(selectedFile.size / 1024).toFixed(2)} KB. No actual binary data is stored.`,
                    parentId: currentParentFolderId,
                    isStarred: false,
                    ownerId: window.userId
                };

                try {
                    await addDoc(collection(window.db, `artifacts/${appId}/users/${window.userId}/files`), uploadedFileRecord);
                    showMessage(`File "${selectedFile.name}" uploaded successfully to Firestore! (Simulated)`);
                    hideManageContentModal();
                } catch (e) {
                    console.error("Error uploading file: ", e);
                    showMessage("Failed to upload file to Firestore.ðŸ˜ž");
                }
            });

            // Close content viewer button
            closeContentViewerBtn.addEventListener('click', closeContentViewer);

            // Universal Escape key listener for modals
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (manageContentModal.classList.contains('show')) {
                        hideManageContentModal();
                    } else if (accountSecurityModal.classList.contains('show')) {
                        hideAccountSecurityModal();
                    }
                    else if (settingsModal.classList.contains('show')) {
                        hideSettingsModal();
                    } else if (contentViewer.classList.contains('show')) {
                        closeContentViewer();
                    }
                }
            });

            // --- Firestore Real-time Listeners Setup ---
            async function setupFirestoreListeners() {
                console.log("setupFirestoreListeners started.");
                if (!window.db || !window.userId) {
                    console.warn("Firestore or userId not available for listeners.");
                    return;
                }

                const userFoldersRef = collection(window.db, `artifacts/${appId}/users/${window.userId}/folders`);
                const userFilesRef = collection(window.db, `artifacts/${appId}/users/${window.userId}/files`);

                let foldersLoaded = false;
                let filesLoaded = false;

                const foldersPromise = new Promise(resolve => {
                    onSnapshot(userFoldersRef, (snapshot) => {
                        window.allFolders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        console.log("All Folders updated from Firestore:", window.allFolders);
                        // Re-render relevant section if active
                        if (currentSection === 'my-drive') {
                            renderMyDriveContent();
                        } else if (currentSection === 'recent') {
                            const files = window.allFiles.map(doc => ({ id: doc.id, ...doc.data() }));
                            const folders = window.allFolders.map(doc => ({ id: doc.id, ...doc.data() }));
                            window.recentFilesFolders = [...files, ...folders].sort((a, b) => {
                                const dateA = new Date(a.modified || 0);
                                const dateB = new Date(b.modified || 0);
                                return dateB.getTime() - dateA.getTime();
                            }).slice(0, 10);
                            handleSidebarNavigation('recent');
                        }
                        if (!foldersLoaded) {
                            foldersLoaded = true;
                            resolve();
                        }
                    }, (error) => {
                        console.error("Error listening to all folders:", error);
                        if (!foldersLoaded) {
                            foldersLoaded = true;
                            resolve(); // Resolve even on error to unblock loading, app might run with partial data
                        }
                    });
                });

                const filesPromise = new Promise(resolve => {
                    onSnapshot(userFilesRef, (snapshot) => {
                        window.allFiles = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        console.log("All Files updated from Firestore:", window.allFiles);
                        // Re-render relevant section if active
                        if (currentSection === 'my-drive') {
                            renderMyDriveContent();
                        } else if (currentSection === 'starred') {
                            window.starredFiles = window.allFiles.filter(f => f.isStarred === true);
                            handleSidebarNavigation('starred');
                        } else if (currentSection === 'recent') {
                            const files = window.allFiles.map(doc => ({ id: doc.id, ...doc.data() }));
                            const folders = window.allFolders.map(doc => ({ id: doc.id, ...doc.data() }));
                            window.recentFilesFolders = [...files, ...folders].sort((a, b) => {
                                const dateA = new Date(a.modified || 0);
                                const dateB = new Date(b.modified || 0);
                                return dateB.getTime() - dateA.getTime();
                            }).slice(0, 10);
                            handleSidebarNavigation('recent');
                        } else if (currentSection === 'shared-with-me') {
                            handleSidebarNavigation('shared-with-me');
                        }
                        if (!filesLoaded) {
                            filesLoaded = true;
                            resolve();
                        }
                    }, (error) => {
                        console.error("Error listening to all files:", error);
                        if (!filesLoaded) {
                            filesLoaded = true;
                            resolve(); // Resolve even on error to unblock loading
                        }
                    });
                });

                await Promise.all([foldersPromise, filesPromise]);
                console.log("Initial Firestore data for folders and files received.");
            }

            // Call setupFirestoreListeners first
            await setupFirestoreListeners();
            console.log("Firestore listeners initialized and initial data loaded.");

            // Ensure Eaglercraft content is present/updated after listeners are set up
            await ensureEaglercraftContent();
            console.log("Eaglercraft content ensured.");

            // Explicitly render My Drive after initial content is set up
            handleSidebarNavigation('my-drive');
            console.log("Initial My Drive content rendered.");

        } // End of initializeSynapseApp
    </script>
</body>
</html>
